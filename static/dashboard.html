<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BhashAI Dashboard - AI Voice Assistant Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Razorpay Checkout Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f8fafc;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        .glass {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .animated-gradient {
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .hover-scale {
            transition: all 0.3s ease;
        }

        .hover-scale:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .metric-card {
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .metric-card:hover::before {
            left: 100%;
        }

        /* Phone number selection styles */
        .phone-number-row {
            transition: all 0.3s ease;
        }

        .phone-number-row:hover {
            background-color: #f3f4f6 !important;
            transform: translateX(2px);
        }

        .phone-number-row.selected {
            background-color: #eff6ff !important;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-item {
            transition: all 0.3s ease;
            border-radius: 12px;
            margin: 4px 0;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 4px solid #fff;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .activity-item {
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            border-left-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            stroke-dasharray: 251.2;
            stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }

        .notification-dot {
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .quick-action {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 16px 24px;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .quick-action::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .quick-action:hover::before {
            left: 100%;
        }

        .quick-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .agent-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .agent-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online { background: #10b981; }
        .status-offline { background: #6b7280; }
        .status-busy { background: #f59e0b; }

        .modal {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.5);
        }

        .dark-mode {
            --light: #1f2937;
            --dark: #f8fafc;
        }

        .theme-toggle {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            width: 60px;
            height: 30px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .theme-toggle.dark::before {
            transform: translateX(30px);
            background: #1f2937;
        }

        /* Settings Navigation Styles */
        .settings-nav-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #6b7280;
            transition: all 0.3s ease;
        }

        .settings-nav-item:hover {
            background: rgba(79, 70, 229, 0.1);
            border-color: rgba(79, 70, 229, 0.2);
            color: #4f46e5;
            transform: translateX(4px);
        }

        .settings-nav-item.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .settings-nav-item.active:hover {
            transform: translateX(4px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .settings-nav-item i {
            transition: all 0.3s ease;
        }

        .settings-nav-item.active i {
            color: white;
        }

        /* Settings Content Styles */
        .settings-content {
            transition: all 0.3s ease;
        }

        .settings-content.hidden {
            display: none;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4f46e5;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div id="sidebar" class="fixed left-0 top-0 h-full w-72 sidebar z-50 transform transition-transform duration-300">
        <div class="p-6">
            <div class="flex items-center mb-8">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center mr-3">
                    <i class="fas fa-microphone-alt text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-white text-xl font-bold">BhashAI</h1>
                    <p class="text-white/70 text-sm">Voice Assistant Platform</p>
                </div>
            </div>

            <!-- Breadcrumb Navigation -->
            <div class="mb-4 p-3 glassmorphism rounded-lg" id="breadcrumbNav">
                <div class="flex items-center text-gray-700 text-sm">
                    <span id="currentLevel">Enterprise</span>
                    <i class="fas fa-chevron-right mx-2 text-xs" id="breadcrumbArrow" style="display: none;"></i>
                    <span id="currentItem" style="display: none;"></span>
                </div>
            </div>

            <nav class="space-y-2">
                <a href="#" class="nav-item active flex items-center p-3 text-white" onclick="showSection('dashboard')">
                    <i class="fas fa-chart-pie mr-3"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('organizations')">
                    <i class="fas fa-building mr-3"></i>
                    <span>Organizations</span>
                    <span class="ml-auto bg-blue-500 text-xs px-2 py-1 rounded-full" id="orgNavCount">0</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('channels')" id="channelsNav" style="display: none;">
                    <i class="fas fa-satellite-dish mr-3 ml-4"></i>
                    <span>Channels</span>
                    <span class="ml-auto bg-purple-500 text-xs px-2 py-1 rounded-full" id="channelNavCount">0</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('agents')" id="agentsNav" style="display: none;">
                    <i class="fas fa-robot mr-3 ml-8"></i>
                    <span>Voice Agents</span>
                    <span class="ml-auto bg-green-500 text-xs px-2 py-1 rounded-full" id="agentNavCount">0</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('contacts')" id="contactsNav" style="display: none;">
                    <i class="fas fa-address-book mr-3 ml-12"></i>
                    <span>Contacts</span>
                    <span class="ml-auto bg-orange-500 text-xs px-2 py-1 rounded-full" id="contactNavCount">0</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('phone-numbers')">
                    <i class="fas fa-phone mr-3"></i>
                    <span>My Phone Numbers</span>
                    <span class="ml-auto bg-cyan-500 text-xs px-2 py-1 rounded-full" id="phoneNavCount">0</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('purchase-phone-numbers')">
                    <i class="fas fa-shopping-cart mr-3"></i>
                    <span>Purchase Phone Numbers</span>
                    <span class="ml-auto bg-green-500 text-xs px-2 py-1 rounded-full">New</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('analytics')">
                    <i class="fas fa-chart-line mr-3"></i>
                    <span>Analytics</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 text-white/80" onclick="showSection('settings')">
                    <i class="fas fa-cog mr-3"></i>
                    <span>Settings</span>
                </a>
            </nav>

            <div class="mt-8 p-4 glassmorphism rounded-xl">
                <div class="flex items-center mb-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-green-400 to-blue-500 flex items-center justify-center mr-3">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                        <p class="text-gray-800 font-medium user-name">Loading...</p>
                        <p class="text-gray-600 text-sm user-email">Loading...</p>
                        <span class="user-role px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">USER</span>
                    </div>
                </div>
                <button onclick="signOut()" class="w-full py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="ml-72 min-h-screen">
        <!-- Header -->
        <header class="glassmorphism border-b border-white/20 p-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Welcome Back! 👋</h1>
                    <p class="text-gray-600">Here's what's happening with your AI assistants today</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="theme-toggle" onclick="toggleTheme()"></div>
                    <button onclick="showNotifications()" class="relative p-3 glassmorphism rounded-full hover:bg-white/20 transition-colors">
                        <i class="fas fa-bell text-gray-700"></i>
                        <span class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-white text-xs flex items-center justify-center notification-dot">3</span>
                    </button>
                    <button onclick="showGlobalSearch()" class="p-3 glassmorphism rounded-full hover:bg-white/20 transition-colors">
                        <i class="fas fa-search text-gray-700"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active p-6">
            <!-- Quick Actions -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <button class="quick-action" onclick="window.location.href='/agent-setup.html'">
                        <i class="fas fa-robot mr-2"></i>
                        Setup Voice Agent
                    </button>
                    <button class="quick-action" onclick="window.location.href='/create-agent.html'">
                        <i class="fas fa-plus mr-2"></i>
                        Create New Agent
                    </button>
                    <button class="quick-action" onclick="window.location.href='/contact-management.html'">
                        <i class="fas fa-users mr-2"></i>
                        Manage Contacts
                    </button>
                    <button class="quick-action" onclick="showCallsModal()">
                        <i class="fas fa-phone mr-2"></i>
                        Start Campaign
                    </button>
                </div>
            </div>

            <!-- Metrics Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="metric-card glassmorphism rounded-2xl p-6 hover-scale" onclick="showSection('organizations')" style="cursor: pointer;">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-building text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">+12% from last month</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="orgCount">0</h3>
                    <p class="text-gray-600">Organizations</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" style="width: 70%"></div>
                    </div>
                </div>

                <div class="metric-card glassmorphism rounded-2xl p-6 hover-scale">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-satellite-dish text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">+15% from last month</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="channelCount">0</h3>
                    <p class="text-gray-600">Channels</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-500 h-2 rounded-full" style="width: 60%"></div>
                    </div>
                </div>

                <div class="metric-card glassmorphism rounded-2xl p-6 hover-scale">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-robot text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">+8% from last month</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="agentCount">0</h3>
                    <p class="text-gray-600">Voice Agents</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                    </div>
                </div>

                <div class="metric-card glassmorphism rounded-2xl p-6 hover-scale">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 flex items-center justify-center">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">+24% from last month</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="contactCount">0</h3>
                    <p class="text-gray-600">Total Contacts</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-orange-500 h-2 rounded-full" style="width: 92%"></div>
                    </div>
                </div>
            </div>

            <!-- Charts and Analytics -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Call Volume Trends</h3>
                    <div class="chart-container">
                        <canvas id="callVolumeChart"></canvas>
                    </div>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Agent Performance</h3>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activity & Active Agents -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Activity</h3>
                    <div class="space-y-3 max-h-80 overflow-y-auto">
                        <div class="activity-item p-3 rounded-lg transition-all">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                <div class="flex-1">
                                    <p class="text-gray-800 font-medium">Sales Agent completed call</p>
                                    <p class="text-gray-500 text-sm">Customer: राजेश कुमार • 2 minutes ago</p>
                                </div>
                                <span class="text-green-500 text-sm">Success</span>
                            </div>
                        </div>
                        <div class="activity-item p-3 rounded-lg transition-all">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                <div class="flex-1">
                                    <p class="text-gray-800 font-medium">New contact added to Support Team</p>
                                    <p class="text-gray-500 text-sm">Contact: प्रिया शर्मा • 5 minutes ago</p>
                                </div>
                                <span class="text-blue-500 text-sm">New</span>
                            </div>
                        </div>
                        <div class="activity-item p-3 rounded-lg transition-all">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-orange-500 rounded-full mr-3"></div>
                                <div class="flex-1">
                                    <p class="text-gray-800 font-medium">Follow-up Reminder scheduled</p>
                                    <p class="text-gray-500 text-sm">Campaign: Customer Check-in • 10 minutes ago</p>
                                </div>
                                <span class="text-orange-500 text-sm">Scheduled</span>
                            </div>
                        </div>
                        <div class="activity-item p-3 rounded-lg transition-all">
                            <div class="flex items-center">
                                <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                                <div class="flex-1">
                                    <p class="text-gray-800 font-medium">Agent training completed</p>
                                    <p class="text-gray-500 text-sm">Agent: Hindi Support Bot • 15 minutes ago</p>
                                </div>
                                <span class="text-purple-500 text-sm">Trained</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Active Voice Agents</h3>
                    <div class="space-y-4">
                        <div class="agent-card">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <div class="status-indicator status-online"></div>
                                    <h4 class="font-semibold text-gray-800">Sales Assistant</h4>
                                </div>
                                <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full">Active</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-3">Hindi/English sales and lead generation assistant</p>
                            <div class="flex justify-between text-sm text-gray-500">
                                <span>Calls Today: 47</span>
                                <span>Success Rate: 94%</span>
                            </div>
                        </div>

                        <div class="agent-card">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <div class="status-indicator status-busy"></div>
                                    <h4 class="font-semibold text-gray-800">Follow-up Assistant</h4>
                                </div>
                                <span class="text-sm bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Busy</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-3">Automated customer follow-up calls in Hindi</p>
                            <div class="flex justify-between text-sm text-gray-500">
                                <span>Calls Today: 23</span>
                                <span>Success Rate: 87%</span>
                            </div>
                        </div>

                        <div class="agent-card">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <div class="status-indicator status-offline"></div>
                                    <h4 class="font-semibold text-gray-800">Customer Support</h4>
                                </div>
                                <span class="text-sm bg-gray-100 text-gray-800 px-2 py-1 rounded-full">Offline</span>
                            </div>
                            <p class="text-gray-600 text-sm mb-3">24/7 customer support in Hindi</p>
                            <div class="flex justify-between text-sm text-gray-500">
                                <span>Calls Today: 0</span>
                                <span>Success Rate: 98%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voice Agents Section -->
        <div id="agents" class="section p-6" style="display: none;">
            <!-- Breadcrumb -->
            <div class="glassmorphism rounded-2xl p-4 mb-6">
                <div class="flex items-center text-gray-600">
                    <button onclick="showSection('organizations')" class="hover:text-blue-600 transition-colors">
                        <i class="fas fa-building mr-2"></i>Organizations
                    </button>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <button onclick="showSection('channels')" class="hover:text-blue-600 transition-colors" id="currentOrgBreadcrumb">
                        Organization
                    </button>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <span class="text-gray-800 font-medium" id="currentChannelName">Channel</span>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <span class="text-blue-600 font-medium">Voice Agents</span>
                </div>
            </div>

            <!-- Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Voice Agents Management</h2>
                        <p class="text-gray-600 mt-2">Manage AI voice assistants for this channel</p>
                    </div>
                    <button onclick="addAgent()" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-plus mr-2"></i>
                        Add Voice Agent
                    </button>
                </div>
            </div>

            <!-- Agent Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-robot text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">Total</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalChannelAgents">0</h3>
                    <p class="text-gray-600">Total Agents</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-play text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">Active</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="activeChannelAgents">0</h3>
                    <p class="text-gray-600">Active Agents</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 flex items-center justify-center">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">Combined</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalAgentContacts">0</h3>
                    <p class="text-gray-600">Total Contacts</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-phone text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">This month</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalAgentCalls">0</h3>
                    <p class="text-gray-600">Total Calls</p>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="agentSearchInput" placeholder="Search agents..." 
                                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   onkeyup="searchAgents()">
                        </div>
                        <select id="agentStatusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterAgents()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="training">Training</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleAgentView('grid')" id="agentGridBtn" class="btn btn-secondary p-2">
                            <i class="fas fa-th"></i>
                        </button>
                        <button onclick="toggleAgentView('list')" id="agentListBtn" class="btn btn-secondary p-2">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Agents List -->
            <div class="glassmorphism rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Channel Agents</h3>
                </div>

                <!-- Agents Grid -->
                <div id="agentsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Agents will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="agentsEmptyState" class="text-center py-12" style="display: none;">
                    <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-gray-400 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">No Voice Agents Found</h3>
                    <p class="text-gray-600 mb-6">Create your first AI voice assistant for this channel</p>
                    <button onclick="addAgent()" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-plus mr-2"></i>
                        Add Voice Agent
                    </button>
                </div>
            </div>
        </div>

        <div id="organizations" class="section p-6" style="display: none;">
            <!-- Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Organizations Management</h2>
                        <p class="text-gray-600 mt-2">Manage your organizations and their channels</p>
                    </div>
                    <button onclick="addOrganization()" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-plus mr-2"></i>
                        Add Organization
                    </button>
                </div>
            </div>

            <!-- Organizations Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-building text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">+12% from last month</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalOrgs">0</h3>
                    <p class="text-gray-600">Total Organizations</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">Active</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="activeOrgs">0</h3>
                    <p class="text-gray-600">Active Organizations</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-sitemap text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">Total</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalChannels">0</h3>
                    <p class="text-gray-600">Total Channels</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 flex items-center justify-center">
                            <i class="fas fa-robot text-white"></i>
                        </div>
                        <span class="text-sm text-gray-500">Across all orgs</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalAgents">0</h3>
                    <p class="text-gray-600">Total Agents</p>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="orgSearchInput" placeholder="Search organizations..." 
                                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   onkeyup="searchOrganizations()">
                        </div>
                        <select id="orgStatusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterOrganizations()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="trial">Trial</option>
                        </select>
                        <select id="orgTypeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterOrganizations()">
                            <option value="">All Types</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="retail">Retail Store</option>
                            <option value="technology">Technology</option>
                            <option value="finance">Finance</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="exportOrganizations()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-download mr-2"></i>
                            Export
                        </button>
                        <button onclick="refreshOrganizations()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Organizations List -->
            <div class="glassmorphism rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Organizations</h3>
                    <div class="flex items-center space-x-2">
                        <button onclick="toggleViewMode('grid')" id="gridViewBtn" class="btn btn-secondary px-3 py-2">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button onclick="toggleViewMode('list')" id="listViewBtn" class="btn btn-secondary px-3 py-2">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="orgLoadingState" class="text-center py-8" style="display: none;">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-500 mb-4"></i>
                    <p class="text-gray-600">Loading organizations...</p>
                </div>

                <!-- Organizations Grid/List Container -->
                <div id="organizationsContainer" class="space-y-4">
                    <!-- Organizations will be dynamically loaded here -->
                </div>

                <!-- Empty State -->
                <div id="orgEmptyState" class="text-center py-12" style="display: none;">
                    <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-building text-gray-400 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">No Organizations Found</h3>
                    <p class="text-gray-600 mb-6">Get started by creating your first organization</p>
                    <button onclick="addOrganization()" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-plus mr-2"></i>
                        Add Organization
                    </button>
                </div>
            </div>
        </div>

        <!-- Organization Modal -->
        <div id="organizationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="glassmorphism rounded-2xl p-8 w-full max-w-2xl mx-4 max-h-screen overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 id="orgModalTitle" class="text-2xl font-bold text-gray-800">Add New Organization</h3>
                    <button onclick="closeOrganizationModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form id="organizationForm" onsubmit="submitOrganization(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Organization Name *</label>
                            <input type="text" id="orgName" name="orgName" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., ABC Enterprises">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Type *</label>
                            <select id="orgType" name="orgType" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Type</option>
                                <option value="retail">Retail / E-commerce</option>
                                <option value="services">Services / Consulting</option>
                                <option value="technology">Technology / Software</option>
                                <option value="finance">Finance / Banking</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="orgStatus" name="orgStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="trial">Trial</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contact Email</label>
                            <input type="email" id="orgEmail" name="orgEmail"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="contact@organization.com">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contact Phone</label>
                            <input type="tel" id="orgPhone" name="orgPhone"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="+91 98765 43210">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                            <textarea id="orgAddress" name="orgAddress" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      placeholder="Organization address"></textarea>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="orgDescription" name="orgDescription" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      placeholder="Brief description of the organization"></textarea>
                        </div>
                    </div>

                    <div class="flex items-center justify-end space-x-4 mt-8">
                        <button type="button" onclick="closeOrganizationModal()" class="btn btn-secondary px-6 py-3">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary px-6 py-3">
                            <i class="fas fa-save mr-2"></i>
                            Save Organization
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Channels Section -->
        <div id="channels" class="section p-6" style="display: none;">
            <!-- Breadcrumb -->
            <div class="glassmorphism rounded-2xl p-4 mb-6">
                <div class="flex items-center text-gray-600">
                    <button onclick="showSection('organizations')" class="hover:text-blue-600 transition-colors">
                        <i class="fas fa-building mr-2"></i>Organizations
                    </button>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <span class="text-gray-800 font-medium" id="currentOrgName">Select Organization</span>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <span class="text-blue-600 font-medium">Channels</span>
                </div>
            </div>

            <!-- Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Channels Management</h2>
                        <p class="text-gray-600 mt-2">Manage communication channels for your organization</p>
                    </div>
                    <button onclick="addChannel()" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-plus mr-2"></i>
                        Add Channel
                    </button>
                </div>
            </div>

            <!-- Channel Types -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="glassmorphism rounded-2xl p-6 cursor-pointer hover:bg-blue-50 transition-colors" onclick="selectChannelType('inbound')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-phone-alt text-white"></i>
                        </div>
                        <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full" id="inboundCount">0</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Inbound Calls</h3>
                    <p class="text-gray-600 text-sm">Handle incoming customer calls</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6 cursor-pointer hover:bg-green-50 transition-colors" onclick="selectChannelType('outbound')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-phone text-white"></i>
                        </div>
                        <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full" id="outboundCount">0</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Outbound Calls</h3>
                    <p class="text-gray-600 text-sm">Make proactive customer calls</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6 cursor-pointer hover:bg-purple-50 transition-colors" onclick="selectChannelType('whatsapp')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fab fa-whatsapp text-white"></i>
                        </div>
                        <span class="text-sm bg-purple-100 text-purple-800 px-2 py-1 rounded-full" id="whatsappCount">0</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">WhatsApp</h3>
                    <p class="text-gray-600 text-sm">WhatsApp messaging integration</p>
                </div>
            </div>

            <!-- Channels List -->
            <div class="glassmorphism rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Active Channels</h3>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="channelSearchInput" placeholder="Search channels..." 
                                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <select id="channelTypeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Types</option>
                            <option value="inbound">Inbound Calls</option>
                            <option value="outbound">Outbound Calls</option>
                            <option value="whatsapp">WhatsApp</option>
                        </select>
                    </div>
                </div>

                <!-- Channels Grid -->
                <div id="channelsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Channels will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="channelsEmptyState" class="text-center py-12" style="display: none;">
                    <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-satellite-dish text-gray-400 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">No Channels Found</h3>
                    <p class="text-gray-600 mb-6">Create your first communication channel</p>
                    <button onclick="addChannel()" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-plus mr-2"></i>
                        Add Channel
                    </button>
                </div>
            </div>
        </div>

        <div id="contacts" class="section p-6" style="display: none;">
            <!-- Breadcrumb -->
            <div class="glassmorphism rounded-2xl p-4 mb-6">
                <div class="flex items-center text-gray-600">
                    <button onclick="showSection('organizations')" class="hover:text-blue-600 transition-colors">
                        <i class="fas fa-building mr-2"></i>Organizations
                    </button>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <button onclick="showSection('channels')" class="hover:text-blue-600 transition-colors" id="contactOrgBreadcrumb">
                        Organization
                    </button>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <button onclick="showSection('agents')" class="hover:text-blue-600 transition-colors" id="contactChannelBreadcrumb">
                        Channel
                    </button>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <span class="text-gray-800 font-medium" id="contactAgentName">Agent</span>
                    <i class="fas fa-chevron-right mx-3 text-gray-400"></i>
                    <span class="text-blue-600 font-medium">Contacts</span>
                </div>
            </div>
            
            <!-- Contacts Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Contacts Management</h2>
                        <p class="text-gray-600 mt-2">Manage contacts for this voice agent</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="importContacts()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-upload mr-2"></i>
                            Import
                        </button>
                        <button onclick="addContact()" class="btn btn-primary px-4 py-2">
                            <i class="fas fa-plus mr-2"></i>
                            Add Contact
                        </button>
                    </div>
                </div>
            </div>

            <!-- Contact Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <span class="text-sm text-blue-600 font-medium">+23</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalContactsCount">1,247</h3>
                    <p class="text-gray-600">Total Contacts</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                        <span class="text-sm text-green-600 font-medium">87%</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="activeContactsCount">1,084</h3>
                    <p class="text-gray-600">Active Contacts</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-phone text-white"></i>
                        </div>
                        <span class="text-sm text-purple-600 font-medium">Today</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="contactedTodayCount">156</h3>
                    <p class="text-gray-600">Contacted Today</p>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 flex items-center justify-center">
                            <i class="fas fa-star text-white"></i>
                        </div>
                        <span class="text-sm text-orange-600 font-medium">Avg</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="responseRateCount">94.2%</h3>
                    <p class="text-gray-600">Response Rate</p>
                </div>
            </div>

            <!-- Contact Filters and Search -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="contactSearchInput" placeholder="Search contacts..." 
                                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   onkeyup="searchContacts()">
                        </div>
                        <select id="contactStatusFilter" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterContacts()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="blocked">Blocked</option>
                        </select>
                        <select id="contactAgentFilter" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterContacts()">
                            <option value="">All Agents</option>
                        </select>
                        <select id="contactLanguageFilter" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="filterContacts()">
                            <option value="">All Languages</option>
                            <option value="hindi">Hindi</option>
                            <option value="english">English</option>
                            <option value="hinglish">Hinglish</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="exportContacts()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-download mr-2"></i>
                            Export
                        </button>
                        <button onclick="bulkActions()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-edit mr-2"></i>
                            Bulk Edit
                        </button>
                    </div>
                </div>
            </div>

            <!-- Contacts List -->
            <div class="glassmorphism rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">All Contacts</h3>
                    <div class="flex items-center space-x-2">
                        <button onclick="toggleContactView('grid')" id="contactGridBtn" class="btn btn-secondary px-3 py-2">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button onclick="toggleContactView('list')" id="contactListBtn" class="btn btn-primary px-3 py-2">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>

                <!-- Bulk Actions Bar -->
                <div id="bulkActionsBar" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-blue-800 font-medium" id="selectedContactsCount">0 contacts selected</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="bulkEdit()" class="btn btn-secondary px-3 py-2 text-sm">
                                <i class="fas fa-edit mr-1"></i>
                                Edit
                            </button>
                            <button onclick="bulkDelete()" class="btn text-red-600 hover:text-red-800 px-3 py-2 text-sm">
                                <i class="fas fa-trash mr-1"></i>
                                Delete
                            </button>
                            <button onclick="clearContactSelection()" class="btn btn-secondary px-3 py-2 text-sm">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="contactsLoadingState" class="text-center py-8" style="display: none;">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-500 mb-4"></i>
                    <p class="text-gray-600">Loading contacts...</p>
                </div>

                <!-- Contacts Container -->
                <div id="contactsContainer" class="space-y-4">
                    <!-- Contacts will be populated here -->
                </div>

                <!-- Pagination -->
                <div class="flex items-center justify-between mt-6">
                    <span class="text-sm text-gray-600" id="contactsPagination">Showing 1-50 of 1,247 contacts</span>
                    <div class="flex items-center space-x-2">
                        <button onclick="previousContactsPage()" class="btn btn-secondary px-3 py-2">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="px-3 py-2 bg-blue-100 text-blue-800 rounded-lg">1</span>
                        <button onclick="nextContactsPage()" class="btn btn-secondary px-3 py-2">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="analytics" class="section p-6" style="display: none;">
            <!-- Analytics Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Advanced Analytics</h2>
                        <p class="text-gray-600 mt-2">Comprehensive insights into your voice agent performance</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <select id="analyticsTimeRange" class="px-4 py-2 border border-gray-300 rounded-lg" onchange="updateAnalytics()">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="365">Last year</option>
                        </select>
                        <button onclick="exportAnalytics()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-download mr-2"></i>
                            Export Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Key Performance Indicators -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-phone text-white"></i>
                        </div>
                        <span class="text-sm text-green-600 font-medium">+15.3%</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="totalCalls">2,847</h3>
                    <p class="text-gray-600">Total Calls</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                    </div>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                        <span class="text-sm text-blue-600 font-medium">+8.7%</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="successRate">94.2%</h3>
                    <p class="text-gray-600">Success Rate</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" style="width: 94%"></div>
                    </div>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-clock text-white"></i>
                        </div>
                        <span class="text-sm text-purple-600 font-medium">-12.4%</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="avgDuration">2:34</h3>
                    <p class="text-gray-600">Avg Call Duration</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-500 h-2 rounded-full" style="width: 68%"></div>
                    </div>
                </div>

                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-orange-500 to-orange-600 flex items-center justify-center">
                            <i class="fas fa-star text-white"></i>
                        </div>
                        <span class="text-sm text-orange-600 font-medium">+5.2%</span>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-1" id="satisfaction">4.7/5</h3>
                    <p class="text-gray-600">Customer Rating</p>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-orange-500 h-2 rounded-full" style="width: 94%"></div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Call Volume Trends -->
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Call Volume Trends</h3>
                        <div class="flex items-center space-x-2">
                            <button onclick="toggleChartType('callTrends', 'line')" class="text-sm text-blue-600 hover:text-blue-800">Line</button>
                            <span class="text-gray-300">|</span>
                            <button onclick="toggleChartType('callTrends', 'bar')" class="text-sm text-blue-600 hover:text-blue-800">Bar</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="callTrendsChart"></canvas>
                    </div>
                </div>

                <!-- Agent Performance -->
                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Top Performing Agents</h3>
                    <div class="chart-container">
                        <canvas id="agentPerformanceChart"></canvas>
                    </div>
                </div>

                <!-- Language Distribution -->
                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Language Distribution</h3>
                    <div class="chart-container">
                        <canvas id="languageChart"></canvas>
                    </div>
                </div>

                <!-- Call Outcomes -->
                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Call Outcomes</h3>
                    <div class="chart-container">
                        <canvas id="outcomeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Analytics Tables -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Real-time Activity -->
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Real-time Activity</h3>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-sm text-gray-600">Live</span>
                        </div>
                    </div>
                    <div id="realtimeActivity" class="space-y-3 max-h-80 overflow-y-auto">
                        <!-- Real-time activities will be populated here -->
                    </div>
                </div>

                <!-- Performance Insights -->
                <div class="glassmorphism rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Performance Insights</h3>
                    <div class="space-y-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-arrow-up text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-green-800">Success Rate Improved</h4>
                                    <p class="text-green-600 text-sm">Up 8.7% compared to last month</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-language text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-blue-800">Hindi Adoption Growing</h4>
                                    <p class="text-blue-600 text-sm">72% of calls now in Hindi/Hinglish</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-yellow-800">Peak Hours Identified</h4>
                                    <p class="text-yellow-600 text-sm">10 AM - 2 PM shows highest volume</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-robot text-white text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-purple-800">AI Accuracy Excellent</h4>
                                    <p class="text-purple-600 text-sm">97.3% intent recognition rate</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Reports -->
            <div class="glassmorphism rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Detailed Reports</h3>
                    <div class="flex items-center space-x-3">
                        <input type="text" id="reportSearch" placeholder="Search reports..." 
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="searchReports()">
                        <button onclick="generateCustomReport()" class="btn btn-primary px-4 py-2">
                            <i class="fas fa-plus mr-2"></i>
                            Custom Report
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Agent</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Total Calls</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Success Rate</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Avg Duration</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Rating</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="settings" class="section p-6" style="display: none;">
            <!-- Settings Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Settings</h2>
                        <p class="text-gray-600 mt-2">Configure your account, preferences, and platform settings</p>
                    </div>
                    <button onclick="saveAllSettings()" class="btn btn-primary px-6 py-3">
                        <i class="fas fa-save mr-2"></i>
                        Save All Changes
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Settings Navigation -->
                <div class="lg:col-span-1">
                    <div class="glassmorphism rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Settings Categories</h3>
                        <nav class="space-y-2">
                            <button onclick="showSettingsTab('account')" class="settings-nav-item active w-full text-left p-3 rounded-lg transition-all">
                                <i class="fas fa-user mr-3"></i>
                                Account Settings
                            </button>
                            <button onclick="showSettingsTab('notifications')" class="settings-nav-item w-full text-left p-3 rounded-lg transition-all">
                                <i class="fas fa-bell mr-3"></i>
                                Notifications
                            </button>
                            <button onclick="showSettingsTab('api')" class="settings-nav-item w-full text-left p-3 rounded-lg transition-all">
                                <i class="fas fa-code mr-3"></i>
                                API & Integrations
                            </button>
                            <button onclick="showSettingsTab('billing')" class="settings-nav-item w-full text-left p-3 rounded-lg transition-all">
                                <i class="fas fa-credit-card mr-3"></i>
                                Billing & Usage
                            </button>
                            <button onclick="showSettingsTab('security')" class="settings-nav-item w-full text-left p-3 rounded-lg transition-all">
                                <i class="fas fa-shield-alt mr-3"></i>
                                Security
                            </button>
                            <button onclick="showSettingsTab('advanced')" class="settings-nav-item w-full text-left p-3 rounded-lg transition-all">
                                <i class="fas fa-cogs mr-3"></i>
                                Advanced
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Settings Content -->
                <div class="lg:col-span-3">
                    <!-- Account Settings -->
                    <div id="accountSettings" class="settings-content">
                        <div class="glassmorphism rounded-2xl p-6 mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Account Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                    <input type="text" id="fullName" class="w-full px-4 py-3 border border-gray-300 rounded-lg" 
                                           value="Dr. Rajesh Kumar" placeholder="Enter your full name">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                                    <input type="email" id="emailAddress" class="w-full px-4 py-3 border border-gray-300 rounded-lg" 
                                           value="rajesh@abcenterprises.com" placeholder="Enter your email">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                    <input type="tel" id="phoneNumber" class="w-full px-4 py-3 border border-gray-300 rounded-lg" 
                                           value="+91 98765 43210" placeholder="Enter your phone">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Time Zone</label>
                                    <select id="timeZone" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                        <option value="Asia/Kolkata" selected>India Standard Time (IST)</option>
                                        <option value="UTC">Coordinated Universal Time (UTC)</option>
                                        <option value="America/New_York">Eastern Time (ET)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Language Preference</label>
                                    <select id="languagePref" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                        <option value="en" selected>English</option>
                                        <option value="hi">हिंदी (Hindi)</option>
                                        <option value="hi-en">Hinglish</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                    <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50" 
                                           value="Enterprise Admin" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="glassmorphism rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Profile Picture</h3>
                            <div class="flex items-center space-x-6">
                                <div class="w-24 h-24 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                                    <span class="text-white text-2xl font-bold">RK</span>
                                </div>
                                <div>
                                    <button onclick="uploadProfilePicture()" class="btn btn-secondary px-4 py-2 mb-2">
                                        <i class="fas fa-upload mr-2"></i>
                                        Upload New Picture
                                    </button>
                                    <p class="text-sm text-gray-600">JPG or PNG, max 5MB</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notifications Settings -->
                    <div id="notificationsSettings" class="settings-content hidden">
                        <div class="glassmorphism rounded-2xl p-6 mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Email Notifications</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Call Summaries</h4>
                                        <p class="text-sm text-gray-600">Daily email with call statistics and summaries</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">System Alerts</h4>
                                        <p class="text-sm text-gray-600">Important system notifications and alerts</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Failed Calls</h4>
                                        <p class="text-sm text-gray-600">Notifications when calls fail or agents go offline</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Weekly Reports</h4>
                                        <p class="text-sm text-gray-600">Comprehensive weekly performance reports</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="glassmorphism rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">SMS Notifications</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Urgent Notifications</h4>
                                        <p class="text-sm text-gray-600">Critical system failures and urgent issues</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Usage Limits</h4>
                                        <p class="text-sm text-gray-600">When approaching call or credit limits</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- API Settings -->
                    <div id="apiSettings" class="settings-content hidden">
                        <div class="glassmorphism rounded-2xl p-6 mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">API Keys</h3>
                            <div class="space-y-4">
                                <div class="p-4 border border-gray-200 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-semibold text-gray-800">Production API Key</h4>
                                        <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">Active</span>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <code class="flex-1 p-2 bg-gray-100 rounded border font-mono text-sm">sk-prod-••••••••••••••••••••••••••••••••</code>
                                        <button onclick="copyApiKey('production')" class="btn btn-secondary px-3 py-2" title="Copy API Key">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <button onclick="regenerateApiKey('production')" class="btn btn-secondary px-3 py-2" title="Regenerate API Key">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-4 border border-gray-200 rounded-lg">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-semibold text-gray-800">Development API Key</h4>
                                        <span class="px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">Testing</span>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <code class="flex-1 p-2 bg-gray-100 rounded border font-mono text-sm">sk-dev-••••••••••••••••••••••••••••••••</code>
                                        <button onclick="copyApiKey('development')" class="btn btn-secondary px-3 py-2" title="Copy API Key">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        <button onclick="regenerateApiKey('development')" class="btn btn-secondary px-3 py-2" title="Regenerate API Key">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button onclick="generateNewApiKey()" class="btn btn-primary px-4 py-2 mt-4">
                                <i class="fas fa-plus mr-2"></i>
                                Generate New API Key
                            </button>
                        </div>

                        <div class="glassmorphism rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Webhook Settings</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Webhook URL</label>
                                    <input type="url" class="w-full px-4 py-3 border border-gray-300 rounded-lg" 
                                           placeholder="https://your-domain.com/webhook" value="https://abcenterprises.com/webhook">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Events to Subscribe</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <label class="flex items-center">
                                            <input type="checkbox" class="mr-2" checked>
                                            Call Started
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" class="mr-2" checked>
                                            Call Ended
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" class="mr-2">
                                            Agent Created
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" class="mr-2">
                                            Contact Added
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Billing Settings -->
                    <div id="billingSettings" class="settings-content hidden">
                        <div class="glassmorphism rounded-2xl p-6 mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Current Plan & Usage</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="text-center p-4 border border-gray-200 rounded-lg">
                                    <h4 class="font-semibold text-gray-800 mb-2">Current Plan</h4>
                                    <p class="text-2xl font-bold text-blue-600">Premium</p>
                                    <p class="text-sm text-gray-600">₹2,999/month</p>
                                </div>
                                <div class="text-center p-4 border border-gray-200 rounded-lg">
                                    <h4 class="font-semibold text-gray-800 mb-2">Calls This Month</h4>
                                    <p class="text-2xl font-bold text-green-600">2,847</p>
                                    <p class="text-sm text-gray-600">of 5,000 included</p>
                                </div>
                                <div class="text-center p-4 border border-gray-200 rounded-lg">
                                    <h4 class="font-semibold text-gray-800 mb-2">Next Billing</h4>
                                    <p class="text-2xl font-bold text-orange-600">Aug 15</p>
                                    <p class="text-sm text-gray-600">₹2,999</p>
                                </div>
                            </div>
                        </div>

                        <div class="glassmorphism rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Payment Methods</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-credit-card text-blue-500 text-xl"></i>
                                        <div>
                                            <h4 class="font-semibold text-gray-800">•••• •••• •••• 4532</h4>
                                            <p class="text-sm text-gray-600">Expires 12/26</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">Primary</span>
                                        <button onclick="editPaymentMethod('primary')" class="text-gray-500 hover:text-gray-700" title="Edit Payment Method">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button onclick="addPaymentMethod()" class="btn btn-primary px-4 py-2 mt-4">
                                <i class="fas fa-plus mr-2"></i>
                                Add Payment Method
                            </button>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div id="securitySettings" class="settings-content hidden">
                        <div class="glassmorphism rounded-2xl p-6 mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Password & Authentication</h3>
                            <div class="space-y-4">
                                <button onclick="showChangePasswordModal()" class="w-full text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="font-semibold text-gray-800">Change Password</h4>
                                            <p class="text-sm text-gray-600">Last changed 30 days ago</p>
                                        </div>
                                        <i class="fas fa-chevron-right text-gray-400"></i>
                                    </div>
                                </button>
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Two-Factor Authentication</h4>
                                        <p class="text-sm text-gray-600">Add an extra layer of security</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="glassmorphism rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Session Management</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Current Session</h4>
                                        <p class="text-sm text-gray-600">Chrome on Windows • 192.168.1.100</p>
                                    </div>
                                    <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">Active</span>
                                </div>
                            </div>
                            <button onclick="signOutAllSessions()" class="btn text-red-600 hover:text-red-800 px-4 py-2 mt-4">
                                <i class="fas fa-sign-out-alt mr-2"></i>
                                Sign Out All Sessions
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Settings -->
                    <div id="advancedSettings" class="settings-content hidden">
                        <div class="glassmorphism rounded-2xl p-6 mb-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">Data & Privacy</h3>
                            <div class="space-y-4">
                                <button onclick="exportAccountData()" class="w-full text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="font-semibold text-gray-800">Export Data</h4>
                                            <p class="text-sm text-gray-600">Download all your account data</p>
                                        </div>
                                        <i class="fas fa-download text-gray-400"></i>
                                    </div>
                                </button>
                                <button onclick="showDeleteAccountModal()" class="w-full text-left p-4 border border-red-200 rounded-lg hover:bg-red-50">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="font-semibold text-red-800">Delete Account</h4>
                                            <p class="text-sm text-red-600">Permanently delete your account and all data</p>
                                        </div>
                                        <i class="fas fa-trash text-red-400"></i>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <div class="glassmorphism rounded-2xl p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">System Preferences</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Analytics Tracking</h4>
                                        <p class="text-sm text-gray-600">Help improve the platform with usage analytics</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">Beta Features</h4>
                                        <p class="text-sm text-gray-600">Access experimental features before they're released</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phone Numbers Section -->
        <div id="phone-numbers" class="section p-6" style="display: none;">
            <!-- Phone Numbers Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Phone Number Management</h2>
                        <p class="text-gray-600 mt-2">Search, purchase, and manage phone numbers from multiple providers</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="refreshPhoneNumbers()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Phone Numbers Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Owned Numbers</p>
                            <p class="text-2xl font-bold text-gray-800" id="ownedNumbersCount">0</p>
                        </div>
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-phone text-white"></i>
                        </div>
                    </div>
                </div>
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Monthly Cost</p>
                            <p class="text-2xl font-bold text-gray-800" id="monthlyPhoneCost">$0.00</p>
                        </div>
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                            <i class="fas fa-dollar-sign text-white"></i>
                        </div>
                    </div>
                </div>
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Active Providers</p>
                            <p class="text-2xl font-bold text-gray-800" id="activeProvidersCount">0</p>
                        </div>
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-purple-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-network-wired text-white"></i>
                        </div>
                    </div>
                </div>
                <div class="glassmorphism rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Countries</p>
                            <p class="text-2xl font-bold text-gray-800" id="countriesCount">0</p>
                        </div>
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-cyan-500 to-cyan-600 flex items-center justify-center">
                            <i class="fas fa-globe text-white"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Owned Phone Numbers -->
            <div class="glassmorphism rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Your Phone Numbers</h3>
                    <div class="flex items-center space-x-3">
                        <input type="text" id="phoneNumberSearch" placeholder="Search phone numbers..."
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeyup="filterPhoneNumbers()">
                        <button onclick="createAgentFromPhoneNumber()"
                                class="btn btn-secondary px-6 py-3 opacity-50 cursor-not-allowed"
                                id="createAgentBtn"
                                disabled
                                title="Select a phone number first">
                            <i class="fas fa-robot mr-2"></i>
                            Select Phone Number First
                        </button>

                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Phone Number</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Country</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Capabilities</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Agent</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Cost</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ownedPhoneNumbersTable">
                            <tr>
                                <td colspan="8" class="text-center py-8 text-gray-500">
                                    <i class="fas fa-phone text-4xl mb-4 opacity-50"></i>
                                    <p>No phone numbers found.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Purchase Phone Numbers Section -->
        <div id="purchase-phone-numbers" class="section p-6" style="display: none;">
            <!-- Purchase Header -->
            <div class="glassmorphism rounded-2xl p-6 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">📱 Your Bolna Phone Numbers</h2>
                        <p class="text-gray-600 mt-2">View and manage your Bolna phone numbers • Rent available numbers</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="refreshAvailableNumbers()" class="btn btn-secondary px-4 py-2">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Refresh
                        </button>
                        <button onclick="showBulkPurchaseModal()" class="btn btn-primary px-6 py-3">
                            <i class="fas fa-shopping-cart mr-2"></i>
                            Bulk Purchase
                        </button>
                    </div>
                </div>
            </div>



            <!-- Available Numbers -->
            <div class="glassmorphism rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">📞 Your Bolna Phone Numbers</h3>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm text-gray-600" id="availableNumbersCount">0 numbers found</span>
                        <button onclick="selectAllNumbers()" class="text-blue-600 hover:text-blue-800 text-sm">
                            Select All
                        </button>
                        <button onclick="clearSelection()" class="text-red-600 hover:text-red-800 text-sm">
                            Clear Selection
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Select</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Phone Number</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Country</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Capabilities</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Cost</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="availableNumbersTable">
                            <tr>
                                <td colspan="8" class="text-center py-8 text-gray-500">
                                    <i class="fas fa-spinner fa-spin text-4xl mb-4 opacity-50"></i>
                                    <p>Loading your Bolna phone numbers...</p>
                                    <p class="text-sm mt-2">Please wait while we fetch your 5 numbers</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Purchase Summary -->
                <div id="purchaseSummary" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg" style="display: none;">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-blue-800">Purchase Summary</h4>
                            <p class="text-sm text-blue-600">
                                <span id="selectedCount">0</span> numbers selected •
                                Setup: $<span id="totalSetupCost">0.00</span> •
                                Monthly: $<span id="totalMonthlyCost">0.00</span>
                            </p>
                        </div>
                        <button onclick="proceedToPurchase()" class="btn btn-primary px-6 py-2">
                            <i class="fas fa-credit-card mr-2"></i>
                            Purchase Selected
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile menu button -->
    <button onclick="toggleMobileMenu()" id="mobileMenuBtn" class="fixed top-4 left-4 z-50 p-3 glassmorphism rounded-full lg:hidden">
        <i class="fas fa-bars text-gray-700"></i>
    </button>



    <!-- Phone Number Purchase Confirmation Modal -->
    <div id="phonePurchaseModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="glassmorphism rounded-2xl p-6 w-full max-w-md">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Confirm Purchase</h3>
                    <button onclick="closePurchaseModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div id="purchaseDetails" class="mb-6">
                    <!-- Purchase details will be populated here -->
                </div>

                <div class="flex items-center justify-end space-x-3">
                    <button onclick="closePurchaseModal()" class="btn btn-secondary px-4 py-2">
                        Cancel
                    </button>
                    <button onclick="confirmPhonePurchase()" class="btn btn-primary px-6 py-2">
                        <i class="fas fa-credit-card mr-2"></i>
                        Purchase
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication state
        let currentUser = null;
        let authToken = null;

        // Initialize Authentication
        async function initializeAuth() {
            try {
                // Check authentication
                authToken = localStorage.getItem('auth_token') || getCookie('auth_token');

                if (!authToken) {
                    console.log('❌ No auth token found, redirecting to login');
                    window.location.href = '/login';
                    return false;
                }

                // Verify token with server
                const response = await fetch('/api/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    console.log('✅ User authenticated:', currentUser.user.email);
                    updateUserInterface();
                    return true;
                } else {
                    console.log('❌ Token invalid, redirecting to login');
                    localStorage.removeItem('auth_token');
                    window.location.href = '/login';
                    return false;
                }

            } catch (error) {
                console.error('❌ Authentication error:', error);
                window.location.href = '/login';
                return false;
            }
        }

        // Update UI with user information
        function updateUserInterface() {
            if (currentUser && currentUser.user) {
                const user = currentUser.user;

                // Update user name in header
                const userNameElements = document.querySelectorAll('.user-name');
                userNameElements.forEach(el => {
                    el.textContent = user.name || user.email;
                });

                // Update user email
                const userEmailElements = document.querySelectorAll('.user-email');
                userEmailElements.forEach(el => {
                    el.textContent = user.email;
                });

                // Update user role badge
                const userRoleElements = document.querySelectorAll('.user-role');
                userRoleElements.forEach(el => {
                    el.textContent = user.role.toUpperCase();
                    el.className = `user-role px-2 py-1 rounded text-xs font-medium ${getRoleColor(user.role)}`;
                });

                // Show/hide admin features based on role
                if (user.role === 'admin') {
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                } else {
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                }
            }
        }

        // Get role color class
        function getRoleColor(role) {
            switch(role) {
                case 'admin': return 'bg-red-100 text-red-800';
                case 'manager': return 'bg-blue-100 text-blue-800';
                case 'user': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Helper function to get cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Logout function
        async function logout() {
            try {
                console.log('🔓 Starting logout process...');

                // Call logout API
                const token = localStorage.getItem('auth_token') || authToken;
                console.log('🔑 Token found:', token ? 'Yes' : 'No');

                if (token) {
                    console.log('📡 Calling logout API...');
                    const response = await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    console.log('📡 Logout API response:', response.status);
                }
            } catch (error) {
                console.error('❌ Logout API error:', error);
            }

            // Clear local storage and redirect
            console.log('🧹 Clearing all storage...');
            localStorage.clear();
            sessionStorage.clear();

            console.log('🔄 Redirecting to login page...');
            window.location.href = '/login';
        }

        // API helper function with authentication
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                }
            };

            const response = await fetch(url, { ...defaultOptions, ...options });

            if (response.status === 401) {
                // Token expired or invalid
                localStorage.removeItem('auth_token');
                window.location.href = '/login';
                return;
            }

            if (!response.ok) {
                let errorMessage = 'API request failed';
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        errorMessage = error.message || error.error || errorMessage;
                    } else {
                        // Handle HTML error responses (like 404 pages)
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                } catch (parseError) {
                    errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }

            return response.json();
        }

        // Fetch dashboard data
        async function fetchDashboardData() {
            try {
                // Fetch organizations
                const orgsResponse = await apiRequest('/api/organizations');
                const organizations = orgsResponse.data || [];
                
                // Calculate hierarchical metrics
                let totalChannels = 0;
                let totalAgents = 0;
                let totalContacts = 0;
                
                for (const org of organizations) {
                    // Fetch channels for each organization
                    try {
                        const channelsResponse = await apiRequest(`/api/organizations/${org.id}/channels`);
                        const channels = channelsResponse.data || [];
                        totalChannels += channels.length;
                        
                        for (const channel of channels) {
                            // Fetch agents for each channel
                            try {
                                const agentsResponse = await apiRequest(`/api/channels/${channel.id}/agents`);
                                const agents = agentsResponse.data || [];
                                totalAgents += agents.length;
                                
                                for (const agent of agents) {
                                    // Fetch contacts for each agent
                                    try {
                                        const contactsResponse = await apiRequest(`/api/agents/${agent.id}/contacts`);
                                        totalContacts += (contactsResponse.data || []).length;
                                    } catch (err) {
                                        console.warn(`Failed to fetch contacts for agent ${agent.id}:`, err);
                                    }
                                }
                            } catch (err) {
                                console.warn(`Failed to fetch agents for channel ${channel.id}:`, err);
                            }
                        }
                    } catch (err) {
                        console.warn(`Failed to fetch channels for organization ${org.id}:`, err);
                    }
                }
                
                // Update hierarchical metrics
                document.getElementById('orgCount').textContent = organizations.length;
                document.getElementById('channelCount').textContent = totalChannels;
                document.getElementById('agentCount').textContent = totalAgents;
                document.getElementById('contactCount').textContent = totalContacts;
                
                // Update navigation counts
                document.getElementById('orgNavCount').textContent = organizations.length;
                document.getElementById('channelNavCount').textContent = totalChannels;
                document.getElementById('agentNavCount').textContent = totalAgents;
                document.getElementById('contactNavCount').textContent = totalContacts;
                
                // Store data globally
                window.dashboardData = {
                    organizations,
                    totalChannels,
                    totalAgents,
                    totalContacts
                };
                
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                // Show default values on error
                document.getElementById('orgCount').textContent = '0';
                document.getElementById('channelCount').textContent = '0';
                document.getElementById('agentCount').textContent = '0';
                document.getElementById('contactCount').textContent = '0';
            }
        }

        // Update active agents display
        function updateActiveAgents(agents) {
            const container = document.querySelector('.space-y-4');
            if (!agents || agents.length === 0) return;
            
            const agentCards = agents.slice(0, 3).map(agent => {
                const status = agent.is_active ? 'online' : 'offline';
                const statusText = agent.is_active ? 'Active' : 'Offline';
                const statusClass = agent.is_active ? 'green' : 'gray';
                
                return `
                    <div class="agent-card">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div class="status-indicator status-${status}"></div>
                                <h4 class="font-semibold text-gray-800">${agent.name || 'Unnamed Agent'}</h4>
                            </div>
                            <span class="text-sm bg-${statusClass}-100 text-${statusClass}-800 px-2 py-1 rounded-full">${statusText}</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-3">${agent.description || 'No description'}</p>
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>Channel: ${agent.channel_name || 'Unknown'}</span>
                            <span>Created: ${new Date(agent.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = agentCards;
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('BhashAI Modern Dashboard loaded successfully!');

            // Initialize authentication first
            const isAuthenticated = await initializeAuth();
            if (!isAuthenticated) {
                return; // Will redirect to login
            }

            console.log('✅ Authentication successful, loading dashboard data...');

            // Fetch real data after authentication
            fetchDashboardData();

            // Initialize charts
            initializeCharts();
            
            // Setup responsive design
            setupResponsiveDesign();
            
            // Animate metrics on load
            animateMetrics();
            
            // Refresh data every 30 seconds
            setInterval(fetchDashboardData, 30000);

            // Test Buy Number functions after everything loads
            setTimeout(() => {
                console.log('🔍 === BUY NUMBER FUNCTION TEST ===');
                console.log('1. window.testBuyNumber:', typeof window.testBuyNumber);
                console.log('2. window.buyNumberWithRazorpay:', typeof window.buyNumberWithRazorpay);
                console.log('3. window.debugBuyButton:', typeof window.debugBuyButton);
                console.log('4. Razorpay library:', typeof Razorpay);

                if (typeof window.testBuyNumber === 'function' && typeof Razorpay !== 'undefined') {
                    console.log('✅ Buy Number functions ready!');
                    console.log('💡 Try: window.testBuyNumber() or click "Test Buy" button');
                } else {
                    console.error('❌ Buy Number functions not ready!');
                    if (typeof Razorpay === 'undefined') {
                        console.error('❌ Razorpay library not loaded');
                    }
                }
            }, 3000);
        });

        // Global state for hierarchical navigation
        let currentOrganization = null;
        let currentChannel = null;
        let currentAgent = null;

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).style.display = 'block';
            
            // Add active class to clicked nav item
            if (event && event.target) {
                event.target.closest('.nav-item').classList.add('active');
            }
            
            // Update breadcrumb and navigation visibility
            updateNavigationState(sectionName);
            
            // Load data for specific sections
            if (sectionName === 'organizations') {
                loadOrganizations();
            } else if (sectionName === 'channels') {
                loadChannels();
            } else if (sectionName === 'agents') {
                loadAgents();
            } else if (sectionName === 'contacts') {
                loadContacts();
            } else if (sectionName === 'phone-numbers') {
                loadPhoneNumbers();
            } else if (sectionName === 'purchase-phone-numbers') {
                loadPurchasePhoneNumbers();
            } else if (sectionName === 'settings') {
                // Initialize settings tabs when settings section is shown
                setTimeout(() => {
                    initializeSettings();
                }, 100);
            }
        }

        // Update navigation state based on current section
        function updateNavigationState(sectionName) {
            const breadcrumb = document.getElementById('currentLevel');
            const breadcrumbArrow = document.getElementById('breadcrumbArrow');
            const currentItem = document.getElementById('currentItem');
            const channelsNav = document.getElementById('channelsNav');
            const agentsNav = document.getElementById('agentsNav');
            const contactsNav = document.getElementById('contactsNav');
            
            // Reset visibility
            channelsNav.style.display = 'none';
            agentsNav.style.display = 'none';
            contactsNav.style.display = 'none';
            breadcrumbArrow.style.display = 'none';
            currentItem.style.display = 'none';
            
            switch(sectionName) {
                case 'dashboard':
                    breadcrumb.textContent = 'Enterprise Dashboard';
                    break;
                case 'organizations':
                    breadcrumb.textContent = 'Enterprise';
                    breadcrumbArrow.style.display = 'inline';
                    currentItem.style.display = 'inline';
                    currentItem.textContent = 'Organizations';
                    break;
                case 'channels':
                    breadcrumb.textContent = 'Enterprise';
                    breadcrumbArrow.style.display = 'inline';
                    currentItem.style.display = 'inline';
                    currentItem.textContent = currentOrganization ? `${currentOrganization.name} → Channels` : 'Channels';
                    channelsNav.style.display = 'block';
                    break;
                case 'agents':
                    breadcrumb.textContent = 'Enterprise';
                    breadcrumbArrow.style.display = 'inline';
                    currentItem.style.display = 'inline';
                    currentItem.textContent = currentChannel ? `${currentOrganization?.name} → ${currentChannel.name} → Agents` : 'Voice Agents';
                    channelsNav.style.display = 'block';
                    agentsNav.style.display = 'block';
                    break;
                case 'contacts':
                    breadcrumb.textContent = 'Enterprise';
                    breadcrumbArrow.style.display = 'inline';
                    currentItem.style.display = 'inline';
                    currentItem.textContent = currentAgent ? `${currentOrganization?.name} → ${currentChannel?.name} → ${currentAgent.name} → Contacts` : 'Contacts';
                    channelsNav.style.display = 'block';
                    agentsNav.style.display = 'block';
                    contactsNav.style.display = 'block';
                    break;
                default:
                    breadcrumb.textContent = 'Enterprise';
            }
        }

        // Navigation functions for hierarchy
        function viewOrganization(orgId) {
            const org = allOrganizations.find(o => o.id === orgId);
            if (org) {
                currentOrganization = org;
                document.getElementById('currentOrgName').textContent = org.name;
                showSection('channels');
            }
        }

        function selectChannelType(type) {
            // Filter channels by type and show channels of that type
            const channels = currentOrganization?.channels?.filter(c => c.type === type) || [];
            displayChannelsByType(type, channels);
        }

        function viewChannel(channelId) {
            const channel = currentOrganization?.channels?.find(c => c.id === channelId);
            if (channel) {
                currentChannel = channel;
                showSection('agents');
            }
        }

        function viewAgent(agentId) {
            const agent = currentChannel?.agents?.find(a => a.id === agentId);
            if (agent) {
                currentAgent = agent;
                showSection('contacts');
            }
        }

        // Channel management functions
        async function loadChannels() {
            if (!currentOrganization) {
                showSection('organizations');
                return;
            }
            
            try {
                const response = await apiRequest(`/api/organizations/${currentOrganization.id}/channels`);
                const channels = response.channels || [];
                
                // Update channel counts
                const inboundCount = channels.filter(c => c.type === 'inbound').length;
                const outboundCount = channels.filter(c => c.type === 'outbound').length;
                const whatsappCount = channels.filter(c => c.type === 'whatsapp').length;
                
                document.getElementById('inboundCount').textContent = inboundCount;
                document.getElementById('outboundCount').textContent = outboundCount;
                document.getElementById('whatsappCount').textContent = whatsappCount;
                
                displayChannels(channels);
            } catch (error) {
                console.error('Error loading channels:', error);
                showChannelsEmptyState();
            }
        }

        function displayChannels(channels) {
            const container = document.getElementById('channelsList');
            const emptyState = document.getElementById('channelsEmptyState');
            
            if (channels.length === 0) {
                showChannelsEmptyState();
                return;
            }
            
            container.style.display = 'grid';
            emptyState.style.display = 'none';
            
            container.innerHTML = channels.map(channel => createChannelCard(channel)).join('');
        }

        function createChannelCard(channel) {
            const typeIcons = {
                inbound: 'phone-alt',
                outbound: 'phone',
                whatsapp: 'fab fa-whatsapp'
            };
            const typeColors = {
                inbound: 'blue',
                outbound: 'green',
                whatsapp: 'purple'
            };
            
            const icon = typeIcons[channel.type] || 'satellite-dish';
            const color = typeColors[channel.type] || 'gray';
            
            return `
                <div class="glassmorphism rounded-2xl p-6 hover-scale cursor-pointer" onclick="viewChannel('${channel.id}')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-${color}-500 to-${color}-600 flex items-center justify-center">
                            <i class="fas ${icon.startsWith('fab') ? icon : 'fa-' + icon} text-white"></i>
                        </div>
                        <span class="text-sm bg-${color}-100 text-${color}-800 px-2 py-1 rounded-full">${channel.status}</span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">${channel.name}</h3>
                    <p class="text-gray-600 text-sm mb-4">${channel.description || 'No description available'}</p>
                    <div class="flex items-center justify-between text-sm text-gray-500">
                        <span><i class="fas fa-robot mr-1"></i>${(channel.agents?.length || 0)} Agents</span>
                        <span><i class="fas fa-users mr-1"></i>${getChannelContactCount(channel)} Contacts</span>
                    </div>
                </div>
            `;
        }

        function getChannelContactCount(channel) {
            let count = 0;
            if (channel.agents) {
                channel.agents.forEach(agent => {
                    count += agent.contacts?.length || 0;
                });
            }
            return count;
        }

        function showChannelsEmptyState() {
            document.getElementById('channelsList').style.display = 'none';
            document.getElementById('channelsEmptyState').style.display = 'block';
        }

        function addChannel() {
            // Implementation for adding new channel
            console.log('Add channel for organization:', currentOrganization?.name);
        }

        // Agent management functions
        async function loadAgents() {
            if (!currentChannel) {
                showSection('channels');
                return;
            }
            
            try {
                const response = await apiRequest(`/api/channels/${currentChannel.id}/agents`);
                const agents = response.agents || [];
                displayAgents(agents);
            } catch (error) {
                console.error('Error loading agents:', error);
                showAgentsEmptyState();
            }
        }

        function displayAgents(agents) {
            const container = document.getElementById('agentsList');
            const emptyState = document.getElementById('agentsEmptyState');
            
            if (agents.length === 0) {
                showAgentsEmptyState();
                return;
            }
            
            container.style.display = 'grid';
            emptyState.style.display = 'none';
            
            // Update breadcrumb
            if (currentOrganization && currentChannel) {
                document.getElementById('currentOrgBreadcrumb').textContent = currentOrganization.name;
                document.getElementById('currentChannelName').textContent = currentChannel.name;
            }
            
            // Update agent stats
            const activeAgents = agents.filter(a => a.status === 'active').length;
            let totalContacts = 0;
            let totalCalls = 0;
            
            agents.forEach(agent => {
                totalContacts += agent.contacts?.length || 0;
                totalCalls += agent.calls_count || 0;
            });
            
            document.getElementById('totalChannelAgents').textContent = agents.length;
            document.getElementById('activeChannelAgents').textContent = activeAgents;
            document.getElementById('totalAgentContacts').textContent = totalContacts;
            document.getElementById('totalAgentCalls').textContent = totalCalls;
            
            container.innerHTML = agents.map(agent => createAgentCard(agent)).join('');
        }

        function createAgentCard(agent) {
            const statusClass = agent.status === 'active' ? 'green' : agent.status === 'training' ? 'yellow' : 'red';
            const statusIcon = agent.status === 'active' ? 'play' : agent.status === 'training' ? 'clock' : 'pause';
            
            return `
                <div class="glassmorphism rounded-2xl p-6 hover-scale cursor-pointer" onclick="viewAgent('${agent.id}')">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-robot text-white"></i>
                        </div>
                        <span class="text-sm bg-${statusClass}-100 text-${statusClass}-800 px-2 py-1 rounded-full flex items-center">
                            <i class="fas fa-${statusIcon} mr-1"></i>${agent.status}
                        </span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">${agent.name}</h3>
                    <p class="text-gray-600 text-sm mb-4">${agent.description || 'No description available'}</p>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex items-center justify-between text-sm text-gray-500">
                            <span><i class="fas fa-users mr-1"></i>Contacts</span>
                            <span class="font-medium">${agent.contacts?.length || 0}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm text-gray-500">
                            <span><i class="fas fa-phone mr-1"></i>Calls (Month)</span>
                            <span class="font-medium">${agent.calls_count || 0}</span>
                        </div>
                        <div class="flex items-center justify-between text-sm text-gray-500">
                            <span><i class="fas fa-percentage mr-1"></i>Success Rate</span>
                            <span class="font-medium">${agent.success_rate || 0}%</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-400">
                            Created: ${new Date(agent.created_at).toLocaleDateString()}
                        </span>
                        <div class="flex items-center space-x-2">
                            <button onclick="event.stopPropagation(); editAgent('${agent.id}')" 
                                    class="text-blue-600 hover:text-blue-800" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteAgent('${agent.id}')" 
                                    class="text-red-600 hover:text-red-800" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showAgentsEmptyState() {
            document.getElementById('agentsList').style.display = 'none';
            document.getElementById('agentsEmptyState').style.display = 'block';
        }

        function addAgent() {
            // Implementation for adding new agent
            console.log('Add agent for channel:', currentChannel?.name);
        }

        function editAgent(agentId) {
            console.log('Edit agent:', agentId);
        }

        function deleteAgent(agentId) {
            console.log('Delete agent:', agentId);
        }

        function searchAgents() {
            // Implementation for searching agents
            console.log('Search agents');
        }

        function filterAgents() {
            // Implementation for filtering agents
            console.log('Filter agents');
        }

        function toggleAgentView(viewType) {
            // Implementation for toggling view
            console.log('Toggle agent view:', viewType);
        }

        // Contact management functions
        async function loadContacts() {
            if (!currentAgent) {
                showSection('agents');
                return;
            }
            
            try {
                const response = await apiRequest(`/api/agents/${currentAgent.id}/contacts`);
                const contacts = response.contacts || [];
                displayContacts(contacts);
            } catch (error) {
                console.error('Error loading contacts:', error);
                showContactsEmptyState();
            }
        }

        function displayContacts(contacts) {
            const container = document.querySelector('#contacts .space-y-4'); // Main contacts container
            const emptyState = document.getElementById('contactsEmptyState');
            
            if (contacts.length === 0) {
                showContactsEmptyState();
                return;
            }
            
            if (container) {
                container.style.display = 'block';
            }
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Update breadcrumb
            if (currentOrganization && currentChannel && currentAgent) {
                document.getElementById('contactOrgBreadcrumb').textContent = currentOrganization.name;
                document.getElementById('contactChannelBreadcrumb').textContent = currentChannel.name;
                document.getElementById('contactAgentName').textContent = currentAgent.name;
            }
            
            // Update contact stats
            const activeContacts = contacts.filter(c => c.status === 'active').length;
            const contactedToday = contacts.filter(c => {
                const today = new Date().toDateString();
                return new Date(c.last_contacted).toDateString() === today;
            }).length;
            
            document.getElementById('totalContactsCount').textContent = contacts.length;
            document.getElementById('activeContactsCount').textContent = activeContacts;
            document.getElementById('contactedTodayCount').textContent = contactedToday;
            
            // Calculate average response rate
            const responsesCount = contacts.filter(c => c.response_rate).length;
            const avgResponseRate = responsesCount > 0 ? 
                contacts.reduce((sum, c) => sum + (c.response_rate || 0), 0) / responsesCount : 0;
            document.getElementById('responseRateCount').textContent = avgResponseRate.toFixed(1) + '%';
            
            // Display contacts (if container exists)
            if (container) {
                container.innerHTML = contacts.map(contact => createContactCard(contact)).join('');
            }
        }

        function createContactCard(contact) {
            const statusClass = contact.status === 'active' ? 'green' : contact.status === 'blocked' ? 'red' : 'gray';
            const lastContacted = contact.last_contacted ? 
                new Date(contact.last_contacted).toLocaleDateString() : 'Never';
            
            return `
                <div class="glassmorphism rounded-2xl p-6 hover-scale">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                                <span class="text-white font-bold">${contact.name.charAt(0).toUpperCase()}</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800">${contact.name}</h3>
                                <p class="text-sm text-gray-500">${contact.phone}</p>
                            </div>
                        </div>
                        <span class="text-sm bg-${statusClass}-100 text-${statusClass}-800 px-2 py-1 rounded-full">
                            ${contact.status}
                        </span>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        ${contact.email ? `<div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-envelope mr-2"></i>${contact.email}
                        </div>` : ''}
                        <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-calendar mr-2"></i>Last contacted: ${lastContacted}
                        </div>
                        ${contact.language ? `<div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-language mr-2"></i>${contact.language}
                        </div>` : ''}
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-400">
                            Added: ${new Date(contact.created_at).toLocaleDateString()}
                        </span>
                        <div class="flex items-center space-x-2">
                            <button onclick="editContact('${contact.id}')" 
                                    class="text-blue-600 hover:text-blue-800" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="callContact('${contact.id}')" 
                                    class="text-green-600 hover:text-green-800" title="Call">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button onclick="deleteContact('${contact.id}')" 
                                    class="text-red-600 hover:text-red-800" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showContactsEmptyState() {
            const container = document.querySelector('#contacts .space-y-4');
            if (container) {
                container.style.display = 'none';
            }
            
            // Could add a specific empty state display here
            console.log('Show contacts empty state for agent:', currentAgent?.name);
        }

        function addContact() {
            console.log('Add contact for agent:', currentAgent?.name);
        }

        function editContact(contactId) {
            console.log('Edit contact:', contactId);
        }

        function deleteContact(contactId) {
            console.log('Delete contact:', contactId);
        }

        function callContact(contactId) {
            console.log('Call contact:', contactId);
        }

        function importContacts() {
            console.log('Import contacts for agent:', currentAgent?.name);
        }

        // Initialize Charts
        function initializeCharts() {
            // Call Volume Chart
            const callVolumeCtx = document.getElementById('callVolumeChart').getContext('2d');
            new Chart(callVolumeCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Successful Calls',
                        data: [650, 789, 845, 923, 1102, 1247],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Failed Calls',
                        data: [45, 52, 38, 67, 73, 89],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(performanceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Successful', 'Failed', 'Pending'],
                    datasets: [{
                        data: [85, 10, 5],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        // Animate metrics on load
        function animateMetrics() {
            const metrics = [
                { id: 'orgCount', target: 2 },
                { id: 'agentCount', target: 5 },
                { id: 'contactCount', target: 124 }
            ];

            metrics.forEach(metric => {
                const element = document.getElementById(metric.id);
                let current = 0;
                const increment = metric.target / 50;
                
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= metric.target) {
                        current = metric.target;
                        clearInterval(timer);
                    }
                    element.textContent = Math.floor(current);
                }, 30);
            });
        }

        // Theme toggle
        function toggleTheme() {
            const toggle = document.querySelector('.theme-toggle');
            toggle.classList.toggle('dark');
            document.body.classList.toggle('dark-mode');
        }

        // Mobile responsiveness
        function setupResponsiveDesign() {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });

            // Close sidebar on mobile when clicking outside
            document.addEventListener('click', (e) => {
                if (window.innerWidth < 1024 && !sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                    sidebar.classList.add('-translate-x-full');
                }
            });
        }

        // Show calls modal
        function showCallsModal() {
            alert('Call campaign feature coming soon! This will allow you to start automated calling campaigns with your voice agents.');
        }

        // Sign out
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                logout();
            }
        }

        // Organization management variables
        let allOrganizations = [];
        let filteredOrganizations = [];
        let currentViewMode = 'list';
        let currentEditingOrg = null;

        // Load organizations data
        async function loadOrganizations() {
            try {
                document.getElementById('orgLoadingState').style.display = 'block';
                document.getElementById('organizationsContainer').style.display = 'none';
                
                const response = await apiRequest('/api/organizations');
                allOrganizations = response.data || [];
                filteredOrganizations = [...allOrganizations];
                
                updateOrganizationStats();
                displayOrganizations();
                
            } catch (error) {
                console.error('Error loading organizations:', error);
                showOrgEmptyState();
            } finally {
                document.getElementById('orgLoadingState').style.display = 'none';
            }
        }

        // Update organization statistics
        function updateOrganizationStats() {
            const total = allOrganizations.length;
            const active = allOrganizations.filter(org => org.status === 'active').length;
            
            // Count channels and agents
            let totalChannels = 0;
            let totalAgents = 0;
            allOrganizations.forEach(org => {
                totalChannels += org.channels?.length || 0;
                if (org.channels) {
                    org.channels.forEach(channel => {
                        totalAgents += channel.agents?.length || 0;
                    });
                }
            });
            
            document.getElementById('totalOrgs').textContent = total;
            document.getElementById('activeOrgs').textContent = active;
            document.getElementById('totalChannels').textContent = totalChannels;
            document.getElementById('totalAgents').textContent = totalAgents;
        }

        // Display organizations
        function displayOrganizations() {
            const container = document.getElementById('organizationsContainer');
            const emptyState = document.getElementById('orgEmptyState');
            
            if (filteredOrganizations.length === 0) {
                showOrgEmptyState();
                return;
            }
            
            container.style.display = 'block';
            emptyState.style.display = 'none';
            
            if (currentViewMode === 'grid') {
                container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                container.innerHTML = filteredOrganizations.map(org => createOrganizationCard(org)).join('');
            } else {
                container.className = 'space-y-4';
                container.innerHTML = filteredOrganizations.map(org => createOrganizationListItem(org)).join('');
            }
        }

        // Create organization card for grid view
        function createOrganizationCard(org) {
            const statusClass = org.status === 'active' ? 'green' : org.status === 'trial' ? 'yellow' : 'red';
            const typeIcon = getTypeIcon(org.type);
            
            return `
                <div class="glassmorphism rounded-2xl p-6 hover-scale cursor-pointer" onclick="viewOrganization('${org.id}')">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                                <i class="fas fa-${typeIcon} text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800">${org.name}</h3>
                                <p class="text-sm text-gray-500">${org.type || 'Unknown'}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 text-xs rounded-full bg-${statusClass}-100 text-${statusClass}-800 font-medium">
                            ${org.status}
                        </span>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        ${org.contact_email ? `<div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-envelope mr-2"></i>${org.contact_email}
                        </div>` : ''}
                        ${org.contact_phone ? `<div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-phone mr-2"></i>${org.contact_phone}
                        </div>` : ''}
                    </div>
                    
                    <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                        <span><i class="fas fa-sitemap mr-1"></i>${(org.channels?.length || 0)} Channels</span>
                        <span><i class="fas fa-robot mr-1"></i>${getOrgAgentCount(org)} Agents</span>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-400">
                            Created: ${new Date(org.created_at).toLocaleDateString()}
                        </span>
                        <div class="flex items-center space-x-2">
                            <button onclick="event.stopPropagation(); editOrganization('${org.id}')" 
                                    class="text-blue-600 hover:text-blue-800" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteOrganization('${org.id}')" 
                                    class="text-red-600 hover:text-red-800" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Create organization list item for list view
        function createOrganizationListItem(org) {
            const statusClass = org.status === 'active' ? 'green' : org.status === 'trial' ? 'yellow' : 'red';
            const typeIcon = getTypeIcon(org.type);
            
            return `
                <div class="glassmorphism rounded-2xl p-6 hover-scale cursor-pointer" onclick="viewOrganization('${org.id}')">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center">
                                <i class="fas fa-${typeIcon} text-white text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <h3 class="text-xl font-bold text-gray-800">${org.name}</h3>
                                    <span class="px-3 py-1 text-sm rounded-full bg-${statusClass}-100 text-${statusClass}-800 font-medium">
                                        ${org.status}
                                    </span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600">
                                    <div><span class="font-medium">Type:</span> ${org.type || 'Unknown'}</div>
                                    <div><span class="font-medium">Channels:</span> ${(org.channels?.length || 0)}</div>
                                    <div><span class="font-medium">Agents:</span> ${getOrgAgentCount(org)}</div>
                                </div>
                                ${org.contact_email || org.contact_phone ? `
                                <div class="flex items-center space-x-6 mt-2 text-sm text-gray-500">
                                    ${org.contact_email ? `<div><i class="fas fa-envelope mr-1"></i>${org.contact_email}</div>` : ''}
                                    ${org.contact_phone ? `<div><i class="fas fa-phone mr-1"></i>${org.contact_phone}</div>` : ''}
                                </div>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="text-right text-sm text-gray-500">
                                <div>Created</div>
                                <div>${new Date(org.created_at).toLocaleDateString()}</div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="event.stopPropagation(); editOrganization('${org.id}')" 
                                        class="btn btn-secondary p-2" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="event.stopPropagation(); deleteOrganization('${org.id}')" 
                                        class="btn text-red-600 hover:text-red-800 p-2" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper functions
        function getTypeIcon(type) {
            const icons = {
                retail: 'store',
                services: 'briefcase',
                technology: 'laptop',
                finance: 'chart-line',
                other: 'building'
            };
            return icons[type] || 'building';
        }

        function getOrgAgentCount(org) {
            let count = 0;
            if (org.channels) {
                org.channels.forEach(channel => {
                    count += channel.agents?.length || 0;
                });
            }
            return count;
        }

        function showOrgEmptyState() {
            document.getElementById('organizationsContainer').style.display = 'none';
            document.getElementById('orgEmptyState').style.display = 'block';
        }

        // Organization CRUD operations
        function addOrganization() {
            currentEditingOrg = null;
            document.getElementById('orgModalTitle').textContent = 'Add New Organization';
            document.getElementById('organizationForm').reset();
            document.getElementById('organizationModal').classList.remove('hidden');
        }

        function editOrganization(orgId) {
            const org = allOrganizations.find(o => o.id === orgId);
            if (!org) return;
            
            currentEditingOrg = org;
            document.getElementById('orgModalTitle').textContent = 'Edit Organization';
            
            // Populate form
            document.getElementById('orgName').value = org.name || '';
            document.getElementById('orgType').value = org.type || '';
            document.getElementById('orgStatus').value = org.status || 'active';
            document.getElementById('orgEmail').value = org.contact_email || '';
            document.getElementById('orgPhone').value = org.contact_phone || '';
            document.getElementById('orgAddress').value = org.address || '';
            document.getElementById('orgDescription').value = org.description || '';
            
            document.getElementById('organizationModal').classList.remove('hidden');
        }

        function viewOrganization(orgId) {
            const org = allOrganizations.find(o => o.id === orgId);
            if (!org) return;
            
            // Store current org for navigation
            localStorage.setItem('currentOrgId', orgId);
            localStorage.setItem('currentOrgName', org.name);
            
            alert(`Organization Details:\n\nName: ${org.name}\nType: ${org.type}\nStatus: ${org.status}\nChannels: ${org.channels?.length || 0}\nAgents: ${getOrgAgentCount(org)}\n\nClick OK to manage this organization's details.`);
        }

        async function deleteOrganization(orgId) {
            const org = allOrganizations.find(o => o.id === orgId);
            if (!org) return;
            
            if (!confirm(`Are you sure you want to delete "${org.name}"?\n\nThis action cannot be undone and will remove all associated channels and agents.`)) {
                return;
            }
            
            try {
                await apiRequest(`/api/organizations/${orgId}`, { method: 'DELETE' });
                
                // Remove from local array
                allOrganizations = allOrganizations.filter(o => o.id !== orgId);
                filteredOrganizations = filteredOrganizations.filter(o => o.id !== orgId);
                
                updateOrganizationStats();
                displayOrganizations();
                
                alert('✅ Organization deleted successfully!');
                
            } catch (error) {
                console.error('Error deleting organization:', error);
                alert('❌ Error deleting organization: ' + error.message);
            }
        }

        async function submitOrganization(event) {
            event.preventDefault();

            const formData = {
                name: document.getElementById('orgName').value,
                type: document.getElementById('orgType').value,
                status: document.getElementById('orgStatus').value,
                email: document.getElementById('orgEmail').value || null,
                phone: document.getElementById('orgPhone').value || null,
                address: document.getElementById('orgAddress').value || null,
                description: document.getElementById('orgDescription').value || null
            };

            console.log('📋 Form Data:', formData);
            
            try {
                let response;
                if (currentEditingOrg) {
                    // Update existing organization
                    response = await apiRequest(`/api/organizations/${currentEditingOrg.id}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                    
                    // Update local array
                    const index = allOrganizations.findIndex(o => o.id === currentEditingOrg.id);
                    if (index !== -1) {
                        allOrganizations[index] = { ...allOrganizations[index], ...response.data };
                    }
                    
                } else {
                    // Create new organization
                    response = await apiRequest('/api/organizations', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });

                    // Add to local array - response.organization contains the created org
                    if (response.organization) {
                        allOrganizations.push(response.organization);
                    }
                }
                
                // Refresh display
                filteredOrganizations = [...allOrganizations];
                updateOrganizationStats();
                displayOrganizations();

                closeOrganizationModal();

                // Show success toast instead of alert
                if (currentEditingOrg) {
                    showToast(`✅ Organization '${formData.name}' updated successfully!`, 'success');
                } else {
                    showToast(`🎉 Organization '${formData.name}' created successfully!`, 'success');
                }
                
            } catch (error) {
                console.error('Error saving organization:', error);
                showToast('❌ Error saving organization: ' + error.message, 'error');
            }
        }

        function closeOrganizationModal() {
            document.getElementById('organizationModal').classList.add('hidden');
            document.getElementById('organizationForm').reset(); // Clear form
            currentEditingOrg = null;
        }

        // Search and filter functions
        function searchOrganizations() {
            const searchTerm = document.getElementById('orgSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('orgStatusFilter').value;
            const typeFilter = document.getElementById('orgTypeFilter').value;
            
            filteredOrganizations = allOrganizations.filter(org => {
                const matchesSearch = org.name.toLowerCase().includes(searchTerm) ||
                                    (org.contact_email && org.contact_email.toLowerCase().includes(searchTerm)) ||
                                    (org.description && org.description.toLowerCase().includes(searchTerm));
                
                const matchesStatus = !statusFilter || org.status === statusFilter;
                const matchesType = !typeFilter || org.type === typeFilter;

                return matchesSearch && matchesStatus && matchesType;
            });
            
            displayOrganizations();
        }

        function filterOrganizations() {
            searchOrganizations(); // Reuse search logic with filters
        }

        function toggleViewMode(mode) {
            currentViewMode = mode;
            
            // Update button states
            document.getElementById('gridViewBtn').className = mode === 'grid' ? 
                'btn btn-primary px-3 py-2' : 'btn btn-secondary px-3 py-2';
            document.getElementById('listViewBtn').className = mode === 'list' ? 
                'btn btn-primary px-3 py-2' : 'btn btn-secondary px-3 py-2';
            
            displayOrganizations();
        }

        function refreshOrganizations() {
            loadOrganizations();
        }

        function exportOrganizations() {
            const csvContent = "data:text/csv;charset=utf-8," +
                "Name,Type,Status,Email,Phone,Channels,Agents,Created\n" +
                filteredOrganizations.map(org => 
                    `"${org.name}","${org.type}","${org.status}","${org.contact_email || ''}","${org.contact_phone || ''}","${org.channels?.length || 0}","${getOrgAgentCount(org)}","${new Date(org.created_at).toLocaleDateString()}"`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "organizations.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Phone Number Management Functions
        let selectedPhoneNumber = null;
        let allPhoneNumbers = []; // Store all phone numbers for filtering

        // Fetch agent details from Bolna API for phone numbers with agent_id
        async function fetchAgentDetailsForPhoneNumbers(phoneNumbers) {
            try {
                // Get all agent IDs that need details
                const agentIds = phoneNumbers
                    .filter(phone => phone.agent_id && !phone.agent_name)
                    .map(phone => phone.agent_id);

                if (agentIds.length === 0) {
                    console.log('ℹ️ No agent IDs found that need details fetching');
                    return;
                }

                console.log(`🔍 Fetching details for ${agentIds.length} agents from Bolna API...`);

                // Call bulk agent details API
                const response = await apiRequest('/api/bolna/agents/bulk-details', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        agent_ids: agentIds
                    })
                });

                if (response.success && response.agents) {
                    // Update phone numbers with agent details
                    phoneNumbers.forEach(phone => {
                        if (phone.agent_id && response.agents[phone.agent_id]) {
                            const agentDetails = response.agents[phone.agent_id];
                            phone.agent_name = agentDetails.name;
                            phone.agent_type = agentDetails.type;
                            phone.agent_status = agentDetails.status;
                            console.log(`✅ Updated agent details for phone ${phone.phone_number}: ${agentDetails.name}`);
                        }
                    });

                    console.log(`✅ Successfully fetched details for ${Object.keys(response.agents).length} agents`);
                } else {
                    console.warn('⚠️ Failed to fetch agent details:', response.message);
                }

            } catch (error) {
                console.error('❌ Error fetching agent details:', error);
            }
        }

        // Load owned phone numbers from both Bolna API and database
        async function loadPhoneNumbers() {
            try {
                let allNumbers = [];
                let summary = {};

                // Try to load from database first (purchased numbers)
                try {
                    const dbResponse = await apiRequest('/api/phone-numbers/owned-simple');
                    if (dbResponse.success && dbResponse.data) {
                        const dbNumbers = dbResponse.data.map(num => ({
                            ...num,
                            source: 'database',
                            owned: true,
                            status: 'Purchased',
                            telephony_provider: num.provider || 'bolna'
                        }));
                        allNumbers = [...allNumbers, ...dbNumbers];
                        console.log(`✅ Loaded ${dbNumbers.length} purchased numbers from database`);
                    }
                } catch (dbError) {
                    console.warn('Could not load from database:', dbError);
                }

                // Then load from Bolna API (available numbers)
                try {
                    const bolnaResponse = await apiRequest('/api/bolna/phone-numbers');
                    if (bolnaResponse.success) {
                        const bolnaNumbers = bolnaResponse.phone_numbers || [];
                        summary = bolnaResponse.summary || {};

                        // Mark Bolna numbers and avoid duplicates
                        const existingNumbers = new Set(allNumbers.map(n => n.phone_number));
                        const newBolnaNumbers = bolnaNumbers
                            .filter(num => !existingNumbers.has(num.phone_number))
                            .map(num => ({
                                ...num,
                                source: 'bolna',
                                owned: true,
                                status: 'Active'
                            }));

                        allNumbers = [...allNumbers, ...newBolnaNumbers];
                        console.log(`✅ Loaded ${newBolnaNumbers.length} numbers from Bolna API`);
                    }
                } catch (bolnaError) {
                    console.warn('Could not load from Bolna API:', bolnaError);
                }

                // Store phone numbers globally for filtering
                allPhoneNumbers = allNumbers;

                // Fetch agent details for phone numbers that have agent_id
                await fetchAgentDetailsForPhoneNumbers(allNumbers);

                updatePhoneNumberStats(allNumbers, summary);
                displayOwnedPhoneNumbers(allNumbers);

                console.log(`📱 Total phone numbers loaded: ${allNumbers.length}`);

            } catch (error) {
                console.error('Error loading phone numbers:', error);
                document.getElementById('ownedPhoneNumbersTable').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4 opacity-50"></i>
                            <p>Error loading phone numbers: ${error.message}</p>
                            <p class="text-sm mt-2">Make sure you're logged in and try refreshing the page</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Update phone number statistics
        function updatePhoneNumberStats(phoneNumbers, summary = {}) {
            // Use summary data if available, otherwise calculate from phone numbers
            const ownedCount = summary.total_numbers || phoneNumbers.length;
            const monthlyCost = summary.monthly_cost || phoneNumbers.reduce((total, num) => {
                // Try to parse price from different formats
                const price = num.price || num.monthly_cost || 0;
                if (typeof price === 'string') {
                    return total + parseFloat(price.replace('$', '')) || 0;
                }
                return total + price;
            }, 0);
            const providers = summary.active_providers || [...new Set(phoneNumbers.map(num => num.telephony_provider || num.provider).filter(Boolean))].length;
            const countries = summary.countries || [...new Set(phoneNumbers.map(num => num.country || num.country_code).filter(Boolean))].length;

            document.getElementById('ownedNumbersCount').textContent = ownedCount;
            document.getElementById('monthlyPhoneCost').textContent = `$${monthlyCost.toFixed(2)}`;
            document.getElementById('activeProvidersCount').textContent = providers;
            document.getElementById('countriesCount').textContent = countries;
            document.getElementById('phoneNavCount').textContent = ownedCount;
        }

        // Display owned phone numbers
        function displayOwnedPhoneNumbers(phoneNumbers) {
            const tableBody = document.getElementById('ownedPhoneNumbersTable');

            if (phoneNumbers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8 text-gray-500">
                            <i class="fas fa-phone text-4xl mb-4 opacity-50"></i>
                            <p>No phone numbers found.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = phoneNumbers.map(phone => `
                <tr class="border-b border-gray-100 hover:bg-gray-50 cursor-pointer phone-number-row"
                    onclick="selectPhoneNumberForAgent('${phone.phone_number}', this)"
                    data-phone-number="${phone.phone_number}"
                    title="Click to select this phone number for creating an agent">
                    <td class="py-3 px-4">
                        <div class="font-medium text-gray-800 font-mono">${phone.phone_number || 'N/A'}</div>
                        <div class="text-sm text-gray-500">
                            ${phone.friendly_name || `BhashAI - ${phone.phone_number || 'N/A'}`}
                            ${phone.source === 'database' ? '<span class="ml-2 px-1 py-0.5 text-xs bg-purple-100 text-purple-800 rounded">Purchased</span>' : ''}
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex items-center">
                            <span class="mr-2">${getCountryFlag(phone.country_code || 'IN')}</span>
                            <span>${phone.country_name || phone.country || 'India'}</span>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-1">
                            ${(phone.capabilities || ['voice', 'sms']).map(cap =>
                                `<span class="px-2 py-1 text-xs ${cap === 'voice' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'} rounded">${cap.toUpperCase()}</span>`
                            ).join('')}
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        ${phone.agent_id ?
                            `<div class="text-sm">
                                <div class="font-medium text-blue-600">${phone.agent_name || 'AI Agent'}</div>
                                <div class="text-xs text-gray-500 font-mono">ID: ${phone.agent_id}</div>
                            </div>` :
                            `<div class="text-sm text-gray-400">
                                <div class="italic">No agent assigned</div>
                                <div class="text-xs">Click 🤖 to create</div>
                            </div>`
                        }
                    </td>
                    <td class="py-3 px-4">
                        <span class="font-medium">
                            ${phone.source === 'database' ?
                                `₹${phone.amount_paid || phone.monthly_cost || '5.0'}` :
                                (phone.price || '$5.0')
                            }
                        </span>
                        <div class="text-xs text-gray-500">
                            ${phone.source === 'database' ? 'paid' : 'monthly'}
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 text-xs rounded-full ${
                            phone.source === 'database' ? 'bg-purple-100 text-purple-800' :
                            phone.rented ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                        }">
                            ${phone.source === 'database' ? 'Purchased' :
                              phone.rented ? 'Active' : 'Available'}
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button onclick="makeDirectCall('${phone.phone_number}')" class="text-green-600 hover:text-green-800" title="Make Call">
                                📞
                            </button>
                            <button onclick="createSalesAgentForPhone('${phone.phone_number}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm font-medium transition-colors" title="Create Sales Agent">
                                Create
                            </button>
                            <button onclick="updateAgentForPhone('${phone.phone_number}', '${phone.agent_id || ''}')" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm font-medium transition-colors" title="Update Agent">
                                Update
                            </button>
                            ${phone.agent_id ?
                                `<button onclick="testAgentCall('${phone.agent_id}', '${phone.phone_number}')" class="text-purple-600 hover:text-purple-800" title="Test Agent Call">
                                    🎯
                                </button>` : ''
                            }
                            <button onclick="viewPhoneDetails('${phone.phone_number}')" class="text-green-600 hover:text-green-800" title="View Details & Manage">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }



        // Show purchase confirmation modal
        function showPurchaseModal(phoneDataStr) {
            try {
                selectedPhoneNumber = JSON.parse(phoneDataStr);

                const modal = document.getElementById('phonePurchaseModal');
                const detailsDiv = document.getElementById('purchaseDetails');

                const totalCost = (selectedPhoneNumber.setup_cost || 0) + (selectedPhoneNumber.monthly_cost || 0);

                detailsDiv.innerHTML = `
                    <div class="space-y-4">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Phone Number Details</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Number:</span>
                                    <span class="font-medium ml-2">${selectedPhoneNumber.phone_number}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Country:</span>
                                    <span class="font-medium ml-2">${selectedPhoneNumber.country_name || selectedPhoneNumber.country_code}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Capabilities:</span>
                                    <div class="flex space-x-1 mt-1">
                                        ${selectedPhoneNumber.capabilities?.voice ? '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Voice</span>' : ''}
                                        ${selectedPhoneNumber.capabilities?.sms ? '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">SMS</span>' : ''}
                                        ${selectedPhoneNumber.capabilities?.mms ? '<span class="px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded">MMS</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Pricing</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between font-semibold">
                                    <span>Total Cost:</span>
                                    <span class="text-green-600">₹1000</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                                <div class="text-sm text-blue-800">
                                    <p class="font-medium mb-1">Important Notes:</p>
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>Phone number will be activated immediately after purchase</li>
                                        <li>One-time payment of ₹1000</li>
                                        <li>You can manage the number anytime from your dashboard</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                modal.classList.remove('hidden');

            } catch (error) {
                console.error('Error showing purchase modal:', error);
                alert('Error displaying purchase details');
            }
        }

        // Close purchase modal
        function closePurchaseModal() {
            document.getElementById('phonePurchaseModal').classList.add('hidden');
            selectedPhoneNumber = null;
        }

        // Confirm phone number purchase
        async function confirmPhonePurchase() {
            if (!selectedPhoneNumber) return;

            try {
                const response = await apiRequest('/api/phone-numbers/purchase', {
                    method: 'POST',
                    body: JSON.stringify({
                        phone_number: selectedPhoneNumber.phone_number,
                        friendly_name: `BhashAI - ${selectedPhoneNumber.phone_number}`,
                        voice_url: window.location.origin + '/webhooks/voice',
                        sms_url: window.location.origin + '/webhooks/sms'
                    })
                });

                if (response.success) {
                    alert('✅ Phone number purchased successfully!');
                    closePurchaseModal();
                    loadPhoneNumbers(); // Refresh the owned numbers list
                } else {
                    throw new Error(response.error || 'Purchase failed');
                }

            } catch (error) {
                console.error('Error purchasing phone number:', error);
                alert('❌ Error purchasing phone number: ' + error.message);
            }
        }

        // Utility functions for phone number management
        function getProviderBadgeClass(provider) {
            switch (provider?.toLowerCase()) {
                case 'twilio': return 'bg-blue-100 text-blue-800';
                case 'telnyx': return 'bg-purple-100 text-purple-800';
                case 'plivo': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusBadgeClass(status) {
            switch (status?.toLowerCase()) {
                case 'active': return 'bg-green-100 text-green-800';
                case 'inactive': return 'bg-red-100 text-red-800';
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getCountryFlag(countryCode) {
            const flags = {
                'US': '🇺🇸', 'IN': '🇮🇳', 'GB': '🇬🇧', 'CA': '🇨🇦', 'AU': '🇦🇺',
                'DE': '🇩🇪', 'FR': '🇫🇷', 'JP': '🇯🇵', 'BR': '🇧🇷', 'MX': '🇲🇽'
            };
            return flags[countryCode] || '🌍';
        }

        // Filter and search functions
        function filterPhoneNumbers() {
            const searchTerm = document.getElementById('phoneNumberSearch').value.toLowerCase();

            // This would filter the displayed phone numbers
            // Implementation depends on how you store the current phone numbers
            console.log('Filtering phone numbers:', { searchTerm });
        }



        // Phone number management actions
        function refreshPhoneNumbers() {
            loadPhoneNumbers();
        }

        // Select phone number for agent creation
        function selectPhoneNumberForAgent(phoneNumber, rowElement) {
            // Remove previous selection
            document.querySelectorAll('.phone-number-row').forEach(row => {
                row.classList.remove('selected', 'bg-blue-50', 'border-blue-200');
                row.style.backgroundColor = '';
                row.style.borderLeft = '';
                row.style.boxShadow = '';
            });

            // Highlight selected row
            rowElement.classList.add('selected');

            // Store selected phone number
            selectedPhoneNumber = { phone_number: phoneNumber };

            // Enable and update create agent button
            const createBtn = document.getElementById('createAgentBtn');
            if (createBtn) {
                createBtn.disabled = false;
                createBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'btn-secondary');
                createBtn.classList.add('btn-primary');
                createBtn.innerHTML = `<i class="fas fa-robot mr-2"></i>Create Agent (${phoneNumber})`;
                createBtn.title = `Create agent with phone number ${phoneNumber}`;
            }

            console.log('Phone number selected for agent creation:', phoneNumber);
        }

        // Create Agent from Phone Number
        function createAgentFromPhoneNumber() {
            // Check if any phone number is selected
            if (!selectedPhoneNumber) {
                alert('⚠️ Please select a phone number first by clicking on any row in the table');
                return;
            }

            // Navigate to create agent page with phone number pre-filled
            const phoneNumber = selectedPhoneNumber.phone_number || selectedPhoneNumber.number;
            window.location.href = `create-agent.html?phone=${encodeURIComponent(phoneNumber)}`;
        }

        // Assign phone number to admin
        function assignPhoneToAdmin(phoneNumber) {
            const adminEmail = prompt(`Assign ${phoneNumber} to admin (enter email):`);
            if (adminEmail) {
                // Here you would make an API call to assign the phone number
                alert(`✅ Phone number ${phoneNumber} assigned to ${adminEmail}`);
                // You could add actual API call here
            }
        }

        // View phone number details and manage agents
        function viewPhoneDetails(phoneNumber) {
            const phone = allPhoneNumbers.find(p => p.phone_number === phoneNumber);
            if (phone) {
                showPhoneDetailsModal(phone);
            }
        }

        // Setup Agent function - redirect to agent setup page
        function setupAgent(phoneNumber, agentId = null) {
            console.log(`Setting up agent for phone: ${phoneNumber}, agent: ${agentId}`);

            // Create URL with parameters
            const params = new URLSearchParams({
                phone_number: phoneNumber
            });

            if (agentId) {
                params.append('agent_id', agentId);
            }

            // Redirect to agent setup page
            window.location.href = `/agent-setup-new.html?${params.toString()}`;
        }

        // Show phone details modal with agent management
        function showPhoneDetailsModal(phone) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="glassmorphism rounded-2xl p-8 max-w-2xl mx-4 max-h-screen overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">📱 Phone Number Details</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <!-- Phone Details -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">📋 Phone Information</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>Number:</strong> ${phone.phone_number}</div>
                                <div><strong>Country:</strong> ${phone.country || 'India'}</div>
                                <div><strong>Provider:</strong> ${phone.telephony_provider || 'Bolna'}</div>
                                <div><strong>Status:</strong> <span class="px-2 py-1 rounded text-xs ${getStatusBadgeClass(phone.status)}">${phone.status || 'Active'}</span></div>
                                <div><strong>Cost:</strong> ₹${phone.cost || '1000'} (one-time)</div>
                                <div><strong>Renewal:</strong> ${phone.renewal_at || 'N/A'}</div>
                            </div>
                        </div>

                        <!-- Agent Management -->
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">🤖 Voice Agent Management</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Current Agent ID</label>
                                    <input type="text" id="agentIdInput"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Enter agent ID or create new agent"
                                           value="${phone.agent_id || ''}">
                                </div>

                                <div class="flex space-x-3">
                                    <button onclick="createSalesAgentForPhone('${phone.phone_number}')"
                                            class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all">
                                        <i class="fas fa-robot mr-2"></i>
                                        Create Sales Agent
                                    </button>
                                    <button onclick="assignExistingAgent('${phone.phone_number}')"
                                            class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all">
                                        <i class="fas fa-link mr-2"></i>
                                        Assign Existing
                                    </button>
                                </div>

                                <div class="text-center">
                                    <button onclick="testPhoneCall('${phone.phone_number}')"
                                            class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-2 rounded-lg hover:from-purple-600 hover:to-purple-700 transition-all">
                                        <i class="fas fa-phone mr-2"></i>
                                        Test Call
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="bg-yellow-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">⚡ Quick Actions</h4>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="viewCallLogs('${phone.phone_number}')"
                                        class="bg-gray-600 text-white px-3 py-2 rounded-lg hover:bg-gray-700 transition-all text-sm">
                                    <i class="fas fa-history mr-1"></i>
                                    Call Logs
                                </button>
                                <button onclick="viewDataHistory('${phone.phone_number}')"
                                        class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition-all text-sm">
                                    <i class="fas fa-chart-line mr-1"></i>
                                    Data History
                                </button>
                                <button onclick="configureWebhooks('${phone.phone_number}')"
                                        class="bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700 transition-all text-sm">
                                    <i class="fas fa-webhook mr-1"></i>
                                    Webhooks
                                </button>
                                <button onclick="manageContacts('${phone.phone_number}')"
                                        class="bg-cyan-600 text-white px-4 py-2 rounded-lg hover:bg-cyan-700 transition-all">
                                    <i class="fas fa-address-book mr-2"></i>
                                    Contacts
                                </button>
                                <button onclick="viewAnalytics('${phone.phone_number}')"
                                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-all">
                                    <i class="fas fa-chart-bar mr-2"></i>
                                    Analytics
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end mt-8">
                        <button onclick="this.closest('.fixed').remove()"
                                class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-all">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Check if phone number already has an agent assigned
        async function checkExistingAgent(phoneNumber) {
            try {
                console.log('🔍 Checking existing agent for phone:', phoneNumber);
                console.log('📱 All phone numbers:', allPhoneNumbers);

                const phone = allPhoneNumbers.find(p => p.phone_number === phoneNumber);
                console.log('📞 Found phone record:', phone);

                if (phone && phone.agent_id) {
                    console.log('🤖 Agent ID found:', phone.agent_id);
                    // Fetch agent details from Bolna API
                    const response = await fetch(`/api/bolna/agents/${phone.agent_id}/details`);
                    if (response.ok) {
                        const agentData = await response.json();
                        console.log('✅ Agent data fetched:', agentData);
                        return {
                            agent_id: phone.agent_id,
                            agent_name: phone.agent_name || agentData.name || 'Unknown Agent',
                            ...agentData
                        };
                    } else {
                        console.log('❌ Failed to fetch agent data:', response.status);
                    }
                } else {
                    console.log('❌ No agent assigned to this phone number');
                }
                return null;
            } catch (error) {
                console.error('Error checking existing agent:', error);
                return null;
            }
        }

        // Show update agent modal
        function showUpdateAgentModal(phoneNumber, existingAgent) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="glassmorphism rounded-2xl p-8 max-w-lg mx-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-edit text-orange-600 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">🔄 Update Existing Agent</h3>
                        <p class="text-gray-600 mb-6">Phone number <strong>${phoneNumber}</strong> already has an agent assigned</p>

                        <div class="bg-orange-50 rounded-lg p-3 mb-6">
                            <div class="flex items-center justify-center">
                                <i class="fas fa-robot text-orange-600 mr-2"></i>
                                <span class="text-orange-800 font-medium">Current Agent: ${existingAgent.name || existingAgent.agent_name || 'Unknown Agent'}</span>
                            </div>
                            <p class="text-xs text-orange-600 mt-1">Agent ID: ${existingAgent.agent_id}</p>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Agent Name</label>
                                <input type="text" id="updateAgentName"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                                       placeholder="Enter new agent name"
                                       value="${existingAgent.name || existingAgent.agent_name || ''}">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Voice Language</label>
                                <select id="updateAgentLanguage" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="hi">Hindi (हिंदी)</option>
                                    <option value="en">English</option>
                                    <option value="hi-en">Hindi + English (Hinglish)</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sales Approach</label>
                                <select id="updateSalesApproach" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="consultative">Consultative (Relationship-focused)</option>
                                    <option value="direct">Direct (Results-focused)</option>
                                    <option value="educational">Educational (Information-focused)</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Agent Welcome Message</label>
                                <textarea id="updateWelcomeMessage"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                                          rows="3"
                                          placeholder="Enter welcome message">${existingAgent.welcome_message || existingAgent.agent_welcome_message || ''}</textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Agent Prompt</label>
                                <textarea id="updateAgentPrompt"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                                          rows="4"
                                          placeholder="Enter detailed agent instructions">${existingAgent.prompt || existingAgent.agent_prompt || ''}</textarea>
                            </div>
                        </div>

                        <div class="flex space-x-3 mt-8">
                            <button onclick="this.closest('.fixed').remove()"
                                    class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-all">
                                Cancel
                            </button>
                            <button onclick="executeAgentUpdate('${phoneNumber}', '${existingAgent.agent_id}')"
                                    class="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 text-white px-4 py-2 rounded-lg hover:from-orange-600 hover:to-orange-700 transition-all"
                                    id="updateAgentBtn">
                                <i class="fas fa-edit mr-2"></i>
                                Update Agent
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Set the dropdown values after the modal is added to DOM
            setTimeout(() => {
                // Set language dropdown
                const languageSelect = document.getElementById('updateAgentLanguage');
                if (languageSelect && existingAgent.language) {
                    languageSelect.value = existingAgent.language;
                    console.log('🔧 Set language to:', existingAgent.language);
                }

                // Set sales approach dropdown - try to get from existing agent data
                const salesApproachSelect = document.getElementById('updateSalesApproach');
                if (salesApproachSelect) {
                    // Try to get sales approach from various possible fields
                    const salesApproach = existingAgent.sales_approach ||
                                        existingAgent.approach ||
                                        'consultative'; // default
                    salesApproachSelect.value = salesApproach;
                    console.log('🔧 Set sales approach to:', salesApproach);
                }

                console.log('✅ Modal populated with existing agent data:', {
                    name: existingAgent.name || existingAgent.agent_name,
                    language: existingAgent.language,
                    welcome_message: existingAgent.welcome_message || existingAgent.agent_welcome_message,
                    prompt: existingAgent.prompt || existingAgent.agent_prompt,
                    sales_approach: existingAgent.sales_approach || existingAgent.approach
                });
            }, 100);
        }

        // Create sales agent for specific phone number
        async function createSalesAgentForPhone(phoneNumber) {
            // First check if this phone number already has an agent
            const existingAgent = await checkExistingAgent(phoneNumber);

            if (existingAgent) {
                // Show update modal instead of create modal
                showUpdateAgentModal(phoneNumber, existingAgent);
                return;
            }
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="glassmorphism rounded-2xl p-8 max-w-lg mx-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-robot text-blue-600 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">🎯 Create Sales Agent</h3>
                        <p class="text-gray-600 mb-6">Create a specialized sales agent for <strong>${phoneNumber}</strong></p>

                        <div class="bg-blue-50 rounded-lg p-3 mb-6">
                            <div class="flex items-center justify-center">
                                <i class="fas fa-phone text-blue-600 mr-2"></i>
                                <span class="text-blue-800 font-medium">Dedicated Agent for ${phoneNumber}</span>
                            </div>
                            <p class="text-xs text-blue-600 mt-1">This agent will be exclusively assigned to this phone number</p>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Agent Name</label>
                                <input type="text" id="quickAgentName"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Enter agent name (e.g., Sales Expert - राज)">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Voice Language</label>
                                <select id="quickAgentLanguage" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="hi">Hindi (हिंदी)</option>
                                    <option value="en">English</option>
                                    <option value="hi-en">Hindi + English (Hinglish)</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sales Approach</label>
                                <select id="quickSalesApproach" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="consultative">Consultative (Relationship-focused)</option>
                                    <option value="direct">Direct (Results-focused)</option>
                                    <option value="educational">Educational (Information-focused)</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Agent Welcome Message</label>
                                <textarea id="quickWelcomeMessage"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          rows="3"
                                          placeholder="Enter welcome message (e.g., नमस्ते! मैं राज हूं, आपका sales assistant। आज मैं आपकी कैसे मदद कर सकता हूं?)"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Agent Prompt</label>
                                <textarea id="quickAgentPrompt"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          rows="4"
                                          placeholder="Enter detailed agent instructions and behavior guidelines..."></textarea>
                            </div>
                        </div>

                        <div class="flex space-x-3 mt-8">
                            <button onclick="this.closest('.fixed').remove()"
                                    class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-all">
                                Cancel
                            </button>
                            <button onclick="executeAgentCreation('${phoneNumber}')"
                                    class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all"
                                    id="createAgentBtn">
                                <i class="fas fa-robot mr-2"></i>
                                Create Agent
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Execute agent creation
        async function executeAgentCreation(phoneNumber) {
            const createBtn = document.getElementById('createAgentBtn');
            const originalText = createBtn.innerHTML;

            createBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
            createBtn.disabled = true;

            try {
                const agentData = {
                    name: document.getElementById('quickAgentName').value,
                    type: 'sales',
                    welcome_message: document.getElementById('quickWelcomeMessage').value || `नमस्ते! मैं ${document.getElementById('quickAgentName').value.split(' - ')[1] || 'राज'} हूं, आपका sales assistant। आज मैं आपकी कैसे मदद कर सकता हूं?`,
                    prompt: document.getElementById('quickAgentPrompt').value || `You are a professional sales assistant. Be helpful, friendly, and focus on understanding customer needs.`,
                    description: `Sales agent for phone number ${phoneNumber}`,
                    voice: document.getElementById('quickAgentLanguage').value === 'hi' ? 'Aditi' : 'Kendra',
                    language: document.getElementById('quickAgentLanguage').value,
                    max_duration: 180,
                    silence_timeout: 15,
                    sales_approach: document.getElementById('quickSalesApproach').value,
                    phone_number: phoneNumber
                };

                console.log('🚀 Creating agent for phone:', phoneNumber, 'with data:', agentData);

                const response = await fetch('/api/bolna/create-sales-agent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(agentData)
                });

                console.log('📡 Response status:', response.status);

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await response.text();
                    console.error('❌ Non-JSON response:', textResponse);
                    throw new Error('Server returned non-JSON response. Check server logs.');
                }

                const result = await response.json();
                console.log('📦 Response data:', result);

                if (response.ok) {
                    // Automatically assign the agent to the phone number
                    if (result.agent_id) {
                        try {
                            console.log(`🔗 Auto-assigning agent ${result.agent_id} to phone ${phoneNumber}`);

                            // Find the phone record to get its ID
                            const phone = allPhoneNumbers.find(p => p.phone_number === phoneNumber);

                            if (phone && phone.id) {
                                const assignResponse = await fetch(`/api/phone-numbers/${phone.id}/assign-agent`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        agent_id: result.agent_id
                                    })
                                });

                                if (assignResponse.ok) {
                                    const assignResult = await assignResponse.json();
                                    console.log('✅ Agent automatically assigned to phone number:', assignResult);
                                    result.assigned_phone = phoneNumber;
                                    result.auto_assigned = true;
                                } else {
                                    console.warn('⚠️ Failed to auto-assign agent to phone number');
                                }
                            } else {
                                console.warn('⚠️ Phone number not found for auto-assignment');
                            }
                        } catch (assignError) {
                            console.warn('⚠️ Error during auto-assignment:', assignError);
                        }
                    }

                    // Close current modal
                    document.querySelector('.fixed').remove();

                    // Show success modal
                    showAgentCreatedSuccess(result, phoneNumber);

                    // Refresh phone numbers to show updated agent ID
                    loadPhoneNumbers();
                } else {
                    throw new Error(result.message || `Server error: ${response.status}`);
                }

            } catch (error) {
                console.error('❌ Agent creation error:', error);

                let errorMessage = 'Unknown error occurred';
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Network connection error. Please check your internet connection.';
                } else if (error.name === 'SyntaxError') {
                    errorMessage = 'Server returned invalid response. Please try again.';
                }

                alert('❌ Error creating agent: ' + errorMessage);
                createBtn.innerHTML = originalText;
                createBtn.disabled = false;
            }
        }

        // Update agent for specific phone number
        async function updateAgentForPhone(phoneNumber, agentId) {
            console.log('🔄 Opening update modal for phone:', phoneNumber, 'agent:', agentId);

            // Check if agent ID exists
            if (!agentId || agentId.trim() === '') {
                console.log('⚠️ No agent assigned to this phone number. Creating new agent instead.');
                createSalesAgentForPhone(phoneNumber);
                return;
            }

            try {
                // Fetch current agent details
                const response = await fetch(`/api/bolna/agents/${agentId}/details`);

                if (!response.ok) {
                    throw new Error(`Failed to fetch agent details: ${response.status} ${response.statusText}`);
                }

                const agentDetails = await response.json();

                console.log('📋 Agent details fetched:', agentDetails);
                console.log('🔍 Detailed agent data:', {
                    name: agentDetails.name,
                    language: agentDetails.language,
                    voice: agentDetails.voice,
                    sales_approach: agentDetails.sales_approach,
                    welcome_message: agentDetails.welcome_message ? agentDetails.welcome_message.substring(0, 50) + '...' : 'None',
                    prompt: agentDetails.prompt ? agentDetails.prompt.substring(0, 50) + '...' : 'None'
                });
                showUpdateAgentModal(phoneNumber, agentDetails);

            } catch (error) {
                console.error('❌ Error fetching agent details:', error);

                // If agent not found, offer to create a new one
                if (error.message.includes('404') || error.message.includes('not found')) {
                    const createNew = confirm(`Agent ${agentId} not found. Would you like to create a new agent for this phone number?`);
                    if (createNew) {
                        createSalesAgentForPhone(phoneNumber);
                    }
                } else {
                    alert('Error fetching agent details: ' + error.message);
                }
            }
        }

        // Execute agent update
        async function executeAgentUpdate(phoneNumber, agentId) {
            const updateBtn = document.getElementById('updateAgentBtn');
            const originalText = updateBtn.innerHTML;

            updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';
            updateBtn.disabled = true;

            try {
                const agentData = {
                    agent_id: agentId,
                    name: document.getElementById('updateAgentName').value,
                    type: 'sales',
                    welcome_message: document.getElementById('updateWelcomeMessage').value,
                    prompt: document.getElementById('updateAgentPrompt').value,
                    description: `Updated sales agent for phone number ${phoneNumber}`,
                    voice: document.getElementById('updateAgentLanguage').value === 'hi' ? 'Aditi' : 'Kendra',
                    language: document.getElementById('updateAgentLanguage').value,
                    max_duration: 180,
                    silence_timeout: 15,
                    sales_approach: document.getElementById('updateSalesApproach').value,
                    phone_number: phoneNumber
                };

                console.log('🔄 Updating agent:', agentId, 'for phone:', phoneNumber, 'with data:', agentData);

                const response = await fetch('/api/bolna/update-sales-agent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(agentData)
                });

                console.log('📡 Update response status:', response.status);

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await response.text();
                    console.error('❌ Non-JSON response:', textResponse);
                    throw new Error('Server returned non-JSON response. Check server logs.');
                }

                const result = await response.json();
                console.log('📦 Update response data:', result);

                if (response.ok) {
                    alert(`✅ Agent ${agentId} updated successfully for ${phoneNumber}!`);

                    // Close modal
                    document.querySelector('.fixed').remove();

                    // Refresh phone numbers to show updated agent info
                    loadPhoneNumbers();
                } else {
                    throw new Error(result.message || `Server error: ${response.status}`);
                }

            } catch (error) {
                console.error('❌ Agent update error:', error);

                let errorMessage = 'Unknown error occurred';
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Network connection error. Please check your internet connection.';
                } else if (error.name === 'SyntaxError') {
                    errorMessage = 'Server returned invalid response. Please try again.';
                }

                alert('❌ Error updating agent: ' + errorMessage);
                updateBtn.innerHTML = originalText;
                updateBtn.disabled = false;
            }
        }

        // Show agent creation success
        function showAgentCreatedSuccess(result, phoneNumber) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="glassmorphism rounded-2xl p-8 max-w-md mx-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-check text-green-600 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">🎉 Agent Created Successfully!</h3>
                        <p class="text-gray-600 mb-6">Your sales agent is ready to start making calls</p>

                        <div class="bg-gray-50 rounded-lg p-4 mb-6 text-left">
                            <div class="space-y-2 text-sm">
                                <div><strong>Agent ID:</strong> <code class="bg-gray-200 px-2 py-1 rounded text-xs">${result.agent_id}</code></div>
                                <div><strong>Agent Name:</strong> <span class="text-blue-600 font-medium">${result.agent_name || 'AI2'}</span></div>
                                <div><strong>Phone Number:</strong> <span class="text-green-600 font-mono">${phoneNumber}</span></div>
                                <div><strong>Status:</strong> <span class="text-green-600 capitalize">${result.status}</span></div>
                            </div>
                        </div>

                        <!-- Assignment Section -->
                        ${!result.auto_assigned ?
                            `<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                    <span class="font-semibold text-gray-800">Assignment: ⚠️ Manual assignment needed</span>
                                </div>
                                <div class="bg-yellow-100 rounded-lg p-3">
                                    <div class="flex items-center text-gray-700 mb-1">
                                        <i class="fas fa-clipboard-list mr-2"></i>
                                        <span class="font-medium">📋 Next Step Required</span>
                                    </div>
                                    <p class="text-sm text-gray-600">
                                        Click "Assign to Phone" below to connect this agent to <strong>${phoneNumber}</strong>.
                                    </p>
                                </div>
                            </div>` :
                            `<div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                    <span class="font-semibold text-gray-800">Assignment: ✅ Auto-assigned</span>
                                </div>
                                <div class="bg-green-100 rounded-lg p-3">
                                    <div class="flex items-center text-gray-700 mb-1">
                                        <i class="fas fa-phone mr-2"></i>
                                        <span class="font-medium">🎯 Ready to Use!</span>
                                    </div>
                                    <p class="text-sm text-gray-600">
                                        Agent is now connected to <strong>${phoneNumber}</strong> and ready to make calls!
                                    </p>
                                </div>
                            </div>`
                        }



                        <div class="space-y-3">
                            ${!result.auto_assigned ?
                                `<button onclick="assignAgentToPhone('${result.agent_id}', '${phoneNumber}')"
                                        class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all">
                                    <i class="fas fa-link mr-2"></i>
                                    Assign to Phone
                                </button>` : ''
                            }
                            <button onclick="testAgentCall('${result.agent_id}', '${phoneNumber}')"
                                    class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white px-4 py-2 rounded-lg hover:from-purple-600 hover:to-purple-700 transition-all">
                                <i class="fas fa-phone mr-2"></i>
                                Test Agent Call
                            </button>
                            <button onclick="this.closest('.fixed').remove(); loadPhoneNumbers();"
                                    class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-all">
                                Close & Refresh
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Test agent call
        async function testAgentCall(agentId, phoneNumber) {
            const testNumber = prompt(`Enter phone number to test call from ${phoneNumber} using agent ${agentId}:`);
            if (testNumber) {
                try {
                    console.log(`🎯 Initiating test call: Agent ${agentId}, From: ${phoneNumber}, To: ${testNumber}`);

                    // Make actual API call
                    const response = await fetch('/api/manual-call', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            recipient_phone: testNumber,
                            sender_phone: phoneNumber,
                            call_type: 'agent_test',
                            contact_name: 'Agent Test Call'
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(`✅ Test call initiated successfully!\n\nFrom: ${phoneNumber}\nTo: ${testNumber}\nAgent: ${agentId}\nCall ID: ${result.call_id || 'N/A'}`);
                    } else {
                        alert(`❌ Test call failed: ${result.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Test call error:', error);
                    alert('❌ Error initiating test call: ' + error.message);
                }
            }
        }

        // Assign existing agent to phone
        function assignExistingAgent(phoneNumber) {
            const agentId = prompt(`Enter Agent ID to assign to ${phoneNumber}:`);
            if (agentId) {
                assignAgentToPhone(agentId, phoneNumber);
            }
        }

        // Assign agent to phone number
        async function assignAgentToPhone(agentId, phoneNumber) {
            try {
                // Find the phone record to get its ID
                const phone = allPhoneNumbers.find(p => p.phone_number === phoneNumber);

                if (!phone || !phone.id) {
                    throw new Error('Phone number not found in your account');
                }

                // Make API call to assign agent to phone number
                const response = await apiRequest(`/api/phone-numbers/${phone.id}/assign-agent`, {
                    method: 'POST',
                    body: JSON.stringify({
                        agent_id: agentId
                    })
                });

                if (response.success) {
                    alert(`✅ Agent ${agentId} assigned to ${phoneNumber} successfully!`);

                    // Update the agent ID in the input field if modal is open
                    const agentInput = document.getElementById('agentIdInput');
                    if (agentInput) {
                        agentInput.value = agentId;
                    }

                    // Close any open modals
                    const modals = document.querySelectorAll('.fixed');
                    modals.forEach(modal => modal.remove());

                    // Refresh phone numbers
                    loadPhoneNumbers();
                } else {
                    throw new Error(response.error || 'Failed to assign agent to phone number');
                }
            } catch (error) {
                console.error('Error assigning agent:', error);
                alert('❌ Error assigning agent: ' + error.message);
            }
        }

        // Test agent call (duplicate function - using same logic as above)
        async function testAgentCall(agentId, phoneNumber) {
            const testNumber = prompt(`Enter test phone number to call from ${phoneNumber}:`);
            if (testNumber) {
                try {
                    console.log(`🧪 Initiating test call: Agent ${agentId}, From: ${phoneNumber}, To: ${testNumber}`);

                    // Make actual API call
                    const response = await fetch('/api/manual-call', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            recipient_phone: testNumber,
                            sender_phone: phoneNumber,
                            call_type: 'agent_test',
                            contact_name: 'Agent Test Call'
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(`✅ Test call initiated successfully!\n\nFrom: ${phoneNumber}\nTo: ${testNumber}\nAgent: ${agentId}\nCall ID: ${result.call_id || 'N/A'}`);
                    } else {
                        alert(`❌ Test call failed: ${result.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Test call error:', error);
                    alert('❌ Error initiating test call: ' + error.message);
                }
            }
        }

        // Test phone call
        async function testPhoneCall(phoneNumber) {
            const testNumber = prompt(`Enter phone number to test call from ${phoneNumber}:`);
            if (testNumber) {
                try {
                    console.log(`📞 Initiating test call from ${phoneNumber} to ${testNumber}`);

                    // Make actual API call
                    const response = await fetch('/api/manual-call', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            recipient_phone: testNumber,
                            sender_phone: phoneNumber,
                            call_type: 'phone_test',
                            contact_name: 'Phone Test Call'
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(`✅ Test call initiated successfully!\n\nFrom: ${phoneNumber}\nTo: ${testNumber}\nCall ID: ${result.call_id || 'N/A'}`);
                    } else {
                        alert(`❌ Test call failed: ${result.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Test call error:', error);
                    alert('❌ Error initiating test call: ' + error.message);
                }
            }
        }

        // Make direct call with better UI
        function makeDirectCall(fromNumber) {
            showCallModal(fromNumber);
        }

        // Show call modal
        function showCallModal(fromNumber) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="glassmorphism rounded-2xl p-6 w-full max-w-md">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">📞 Make Call</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">From Number</label>
                            <input type="text" value="${fromNumber}" readonly
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">To Number</label>
                            <input type="tel" id="toNumber" placeholder="+91XXXXXXXXXX"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Call Type</label>
                            <select id="callType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="test">Test Call</option>
                                <option value="sales">Sales Call</option>
                                <option value="support">Support Call</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex space-x-3 mt-6">
                        <button onclick="this.closest('.fixed').remove()"
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="initiateCall('${fromNumber}')"
                                class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700">
                            📞 Call Now
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Focus on to number input
            setTimeout(() => {
                document.getElementById('toNumber').focus();
            }, 100);
        }

        // Initiate the actual call
        async function initiateCall(fromNumber) {
            const toNumber = document.getElementById('toNumber').value;
            const callType = document.getElementById('callType').value;

            if (!toNumber) {
                alert('Please enter a phone number to call');
                return;
            }

            // Validate phone number format
            const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
            if (!phoneRegex.test(toNumber.replace(/\s/g, ''))) {
                alert('Please enter a valid phone number');
                return;
            }

            // Close modal
            document.querySelector('.fixed').remove();

            // Show calling status
            showCallingStatus(fromNumber, toNumber, callType);

            try {
                // Make actual API call to backend
                const response = await fetch('/api/manual-call', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        recipient_phone: toNumber,
                        sender_phone: fromNumber,
                        call_type: callType,
                        contact_name: 'Manual Call Contact'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('✅ Call initiated successfully:', result);
                    updateCallStatus('success', result);

                    // Show additional info if it's a demo call
                    if (result.note && result.note.includes('Demo Mode')) {
                        setTimeout(() => {
                            const modal = document.getElementById('callStatusModal');
                            if (modal) {
                                const message = modal.querySelector('#callStatusMessage');
                                message.innerHTML += `
                                    <div class="mt-2 p-2 bg-blue-50 rounded text-blue-700 text-xs">
                                        💡 This is a demo call. To make real calls, configure Bolna API credentials.
                                    </div>
                                `;
                            }
                        }, 1000);
                    }
                } else {
                    console.error('❌ Call failed:', result);
                    updateCallStatus('failed', result);
                }

            } catch (error) {
                console.error('❌ API call failed:', error);
                updateCallStatus('error', { message: error.message });
            }
        }

        // Show calling status
        function showCallingStatus(fromNumber, toNumber, callType) {
            const statusModal = document.createElement('div');
            statusModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            statusModal.id = 'callStatusModal';
            statusModal.innerHTML = `
                <div class="glassmorphism rounded-2xl p-6 w-full max-w-md text-center">
                    <div id="callStatusIcon" class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-phone text-blue-600 text-2xl animate-pulse"></i>
                    </div>
                    <h3 id="callStatusTitle" class="text-xl font-bold text-gray-800 mb-2">📞 Initiating Call...</h3>
                    <p id="callStatusDetails" class="text-gray-600 mb-4">
                        From: <span class="font-mono">${fromNumber}</span><br>
                        To: <span class="font-mono">${toNumber}</span><br>
                        Type: <span class="capitalize">${callType}</span>
                    </p>
                    <div id="callStatusMessage" class="text-sm text-gray-500 mb-4">
                        Connecting to Bolna AI voice system...
                    </div>
                    <div id="callActions" class="flex space-x-3">
                        <button onclick="this.closest('.fixed').remove()"
                                class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(statusModal);
        }

        // Update call status based on API response
        function updateCallStatus(status, result) {
            const modal = document.getElementById('callStatusModal');
            if (!modal) return;

            const icon = modal.querySelector('#callStatusIcon');
            const title = modal.querySelector('#callStatusTitle');
            const message = modal.querySelector('#callStatusMessage');
            const actions = modal.querySelector('#callActions');

            if (status === 'success') {
                icon.innerHTML = '<i class="fas fa-phone text-green-600 text-2xl"></i>';
                icon.className = 'w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4';
                title.textContent = '✅ Call Connected!';
                message.innerHTML = `
                    <div class="text-green-600 font-medium">Call ID: ${result.call_id || 'N/A'}</div>
                    <div class="text-sm text-gray-500 mt-1">Voice agent is now speaking with the contact</div>
                `;
                actions.innerHTML = `
                    <button onclick="this.closest('.fixed').remove()"
                            class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                        ✅ Done
                    </button>
                `;
            } else if (status === 'failed') {
                icon.innerHTML = '<i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>';
                icon.className = 'w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4';
                title.textContent = '❌ Call Failed';
                message.innerHTML = `
                    <div class="text-red-600 font-medium">${result.message || 'Unknown error'}</div>
                    <div class="text-sm text-gray-500 mt-1">Please try again or contact support</div>
                `;
                actions.innerHTML = `
                    <button onclick="this.closest('.fixed').remove()"
                            class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                        Close
                    </button>
                `;
            } else if (status === 'error') {
                icon.innerHTML = '<i class="fas fa-wifi text-orange-600 text-2xl"></i>';
                icon.className = 'w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4';
                title.textContent = '⚠️ Connection Error';
                message.innerHTML = `
                    <div class="text-orange-600 font-medium">Network or server error</div>
                    <div class="text-sm text-gray-500 mt-1">${result.message || 'Please check your connection'}</div>
                `;
                actions.innerHTML = `
                    <button onclick="this.closest('.fixed').remove()"
                            class="flex-1 bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600">
                        Close
                    </button>
                `;
            }
        }



        // View call logs
        async function viewCallLogs(phoneNumber) {
            try {
                console.log(`📊 Fetching call logs for ${phoneNumber}...`);

                // Show loading modal
                showCallLogsModal(phoneNumber, 'loading');

                // Fetch call logs from Bolna API
                const token = localStorage.getItem('auth_token') || authToken;
                const response = await fetch('/api/call-logs', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone_number: phoneNumber
                    })
                });

                if (response.ok) {
                    const callLogs = await response.json();
                    console.log('📞 Call logs received:', callLogs);
                    showCallLogsModal(phoneNumber, 'success', callLogs);
                } else {
                    console.error('❌ Failed to fetch call logs:', response.status);
                    showCallLogsModal(phoneNumber, 'error');
                }

            } catch (error) {
                console.error('❌ Error fetching call logs:', error);
                showCallLogsModal(phoneNumber, 'error');
            }
        }

        // Show call logs modal
        function showCallLogsModal(phoneNumber, status, callLogs = []) {
            const modalHtml = `
                <div id="callLogsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">
                                📞 Call Logs - ${phoneNumber}
                            </h3>
                            <button onclick="closeCallLogsModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div id="callLogsContent">
                            ${getCallLogsContent(status, callLogs)}
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('callLogsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add new modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Get call logs content based on status
        function getCallLogsContent(status, callLogs) {
            if (status === 'loading') {
                return `
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">Loading call logs...</p>
                    </div>
                `;
            }

            if (status === 'error') {
                return `
                    <div class="text-center py-8">
                        <div class="text-red-500 text-4xl mb-4">❌</div>
                        <p class="text-gray-600">Failed to load call logs. Please try again.</p>
                        <button onclick="closeCallLogsModal()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            Close
                        </button>
                    </div>
                `;
            }

            if (!callLogs || callLogs.length === 0) {
                return `
                    <div class="text-center py-8">
                        <div class="text-gray-400 text-4xl mb-4">📞</div>
                        <p class="text-gray-600">No call logs found for this number.</p>
                        <button onclick="closeCallLogsModal()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            Close
                        </button>
                    </div>
                `;
            }

            // Display call logs
            return `
                <div class="space-y-4">
                    ${callLogs.map(call => `
                        <div class="border rounded-lg p-4 hover:bg-gray-50">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center space-x-2">
                                    <span class="text-lg">${call.direction === 'inbound' ? '📞' : '📱'}</span>
                                    <span class="font-semibold">${call.direction === 'inbound' ? 'Incoming' : 'Outgoing'}</span>
                                    <span class="text-sm text-gray-500">•</span>
                                    <span class="text-sm text-gray-600">${call.from_number || 'Unknown'}</span>
                                </div>
                                <span class="text-sm text-gray-500">${formatDate(call.created_at)}</span>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-500">Duration:</span>
                                    <span class="ml-1 font-medium">${formatDuration(call.duration)}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Status:</span>
                                    <span class="ml-1 font-medium ${getStatusColor(call.status)}">${call.status}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Cost:</span>
                                    <span class="ml-1 font-medium">₹${call.cost || '0.00'}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Agent:</span>
                                    <span class="ml-1 font-medium">${call.agent_name || 'Not Assigned'}</span>
                                </div>
                            </div>

                            ${call.recording_url ? `
                                <div class="mt-3 pt-3 border-t">
                                    <button onclick="playRecording('${call.recording_url}')"
                                            class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                        🎵 Play Recording
                                    </button>
                                </div>
                            ` : ''}

                            ${call.transcript ? `
                                <div class="mt-3 pt-3 border-t">
                                    <details class="cursor-pointer">
                                        <summary class="font-medium text-gray-700 hover:text-gray-900">
                                            📝 View Transcript
                                        </summary>
                                        <div class="mt-2 p-3 bg-gray-50 rounded text-sm whitespace-pre-wrap">
                                            ${call.transcript}
                                        </div>
                                    </details>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>

                <div class="mt-6 text-center">
                    <button onclick="closeCallLogsModal()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">
                        Close
                    </button>
                </div>
            `;
        }

        // Close call logs modal
        function closeCallLogsModal() {
            const modal = document.getElementById('callLogsModal');
            if (modal) {
                modal.remove();
            }
        }

        // View Data History
        async function viewDataHistory(phoneNumber) {
            try {
                showDataHistoryModal(phoneNumber, 'loading');

                // Get authentication token
                const token = localStorage.getItem('auth_token') || authToken;

                // Fetch data history from API with authentication
                const response = await fetch(`/api/phone/${phoneNumber}/data-history`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showDataHistoryModal(phoneNumber, 'success', data);
                } else {
                    console.error('❌ Data history API error:', data);
                    showDataHistoryModal(phoneNumber, 'error', data.error || 'Failed to load data');
                }
            } catch (error) {
                console.error('❌ Error fetching data history:', error);
                showDataHistoryModal(phoneNumber, 'error', error.message);
            }
        }

        // Show data history modal
        function showDataHistoryModal(phoneNumber, status, historyData = {}, errorMessage = '') {
            const modalHtml = `
                <div id="dataHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-900">
                                <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                                Data History & Analytics - ${phoneNumber}
                            </h3>
                            <button onclick="closeDataHistoryModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <!-- Filter Controls -->
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                                    <select id="dateRange" onchange="refreshDataHistory('${phoneNumber}')" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="7">Last 7 Days</option>
                                        <option value="30">Last 30 Days</option>
                                        <option value="90">Last 90 Days</option>
                                        <option value="365">Last Year</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Type</label>
                                    <select id="dataType" onchange="refreshDataHistory('${phoneNumber}')" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="all">All Data</option>
                                        <option value="calls">Call Records</option>
                                        <option value="sms">SMS Records</option>
                                        <option value="usage">Usage Stats</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Export Format</label>
                                    <select id="exportFormat" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="csv">CSV</option>
                                        <option value="json">JSON</option>
                                        <option value="pdf">PDF Report</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="refreshDataHistory('${phoneNumber}')" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-all">
                                        <i class="fas fa-sync-alt mr-2"></i>
                                        Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        ${getDataHistoryContent(status, historyData, errorMessage)}
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('dataHistoryModal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Get data history content based on status
        function getDataHistoryContent(status, historyData, errorMessage = '') {
            if (status === 'loading') {
                return `
                    <div class="text-center py-12">
                        <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                        <p class="text-gray-600 text-lg">Loading data history...</p>
                    </div>
                `;
            }

            if (status === 'error') {
                const errorDisplay = errorMessage ?
                    `<p class="text-red-600 text-lg mb-2">Failed to load data history</p>
                     <p class="text-red-500 mb-4">${errorMessage}</p>` :
                    `<p class="text-red-600 text-lg mb-4">Failed to load data history</p>`;

                return `
                    <div class="text-center py-12">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        ${errorDisplay}
                        <button onclick="refreshDataHistory()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Try Again
                        </button>
                    </div>
                `;
            }

            // Success - show statistics and data
            const stats = historyData.statistics || {};
            const records = historyData.records || [];

            return `
                <!-- Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm">Total Calls</p>
                                <p class="text-2xl font-bold">${stats.totalCalls || 0}</p>
                            </div>
                            <i class="fas fa-phone text-3xl text-blue-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm">Total SMS</p>
                                <p class="text-2xl font-bold">${stats.totalSMS || 0}</p>
                            </div>
                            <i class="fas fa-sms text-3xl text-green-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm">Total Cost</p>
                                <p class="text-2xl font-bold">₹${stats.totalCost || 0}</p>
                            </div>
                            <i class="fas fa-rupee-sign text-3xl text-purple-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm">Avg Duration</p>
                                <p class="text-2xl font-bold">${stats.avgDuration || '0s'}</p>
                            </div>
                            <i class="fas fa-clock text-3xl text-orange-200"></i>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="text-lg font-semibold mb-4">Usage Trends (Last 30 Days)</h4>
                        <div class="h-64 flex items-center justify-center bg-gray-50 rounded">
                            <div class="text-center">
                                <i class="fas fa-chart-line text-4xl text-gray-400 mb-2"></i>
                                <p class="text-gray-500">Chart will be implemented with Chart.js</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="text-lg font-semibold mb-4">Cost Analysis</h4>
                        <div class="h-64 flex items-center justify-center bg-gray-50 rounded">
                            <div class="text-center">
                                <i class="fas fa-chart-pie text-4xl text-gray-400 mb-2"></i>
                                <p class="text-gray-500">Chart will be implemented with Chart.js</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="bg-white border rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b bg-gray-50">
                        <div class="flex justify-between items-center">
                            <h4 class="text-lg font-semibold">Recent Activity Records</h4>
                            <button onclick="exportDataHistory()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-all">
                                <i class="fas fa-download mr-2"></i>
                                Export Data
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        ${getDataHistoryTable(records)}
                    </div>
                </div>
            `;
        }

        // Get data history table
        function getDataHistoryTable(records) {
            if (!records || records.length === 0) {
                return `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">No data records found</p>
                    </div>
                `;
            }

            const tableRows = records.map(record => {
                const typeIcon = record.type === 'call' ? 'fa-phone' : 'fa-sms';
                const typeColor = record.type === 'call' ? 'text-blue-600' : 'text-green-600';
                const statusBadge = getStatusBadge(record.status);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i class="fas ${typeIcon} ${typeColor} mr-2"></i>
                                <span class="text-sm font-medium text-gray-900">${record.type.toUpperCase()}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${record.to || record.from || '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${formatDateTime(record.timestamp)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${record.duration || '-'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${statusBadge}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ₹${record.cost || '0.00'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewRecordDetails('${record.id}')" class="text-blue-600 hover:text-blue-900">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Number</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${tableRows}
                    </tbody>
                </table>
            `;
        }

        // Get status badge
        function getStatusBadge(status) {
            const badges = {
                'completed': '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Completed</span>',
                'failed': '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Failed</span>',
                'in-progress': '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">In Progress</span>',
                'pending': '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Pending</span>'
            };
            return badges[status] || '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Unknown</span>';
        }

        // Format date time
        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Close data history modal
        function closeDataHistoryModal() {
            const modal = document.getElementById('dataHistoryModal');
            if (modal) {
                modal.remove();
            }
        }

        // Refresh data history
        async function refreshDataHistory(phoneNumber) {
            if (!phoneNumber) {
                // Get phone number from modal title or current context
                const modal = document.getElementById('dataHistoryModal');
                if (modal) {
                    const titleElement = modal.querySelector('h3');
                    if (titleElement) {
                        phoneNumber = titleElement.textContent.split(' - ')[1];
                    }
                }
            }

            if (phoneNumber) {
                await viewDataHistory(phoneNumber);
            }
        }

        // Export data history
        function exportDataHistory() {
            const format = document.getElementById('exportFormat')?.value || 'csv';
            const dateRange = document.getElementById('dateRange')?.value || '30';
            const dataType = document.getElementById('dataType')?.value || 'all';

            // Get phone number from modal
            const modal = document.getElementById('dataHistoryModal');
            let phoneNumber = '';
            if (modal) {
                const titleElement = modal.querySelector('h3');
                if (titleElement) {
                    phoneNumber = titleElement.textContent.split(' - ')[1];
                }
            }

            if (!phoneNumber) {
                showNotification('Error: Phone number not found', 'error');
                return;
            }

            // Create download URL
            const params = new URLSearchParams({
                phone: phoneNumber,
                format: format,
                days: dateRange,
                type: dataType
            });

            const downloadUrl = `/api/phone/${phoneNumber}/export-data?${params.toString()}`;

            // Create temporary download link
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `${phoneNumber}_data_history_${dateRange}days.${format}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification(`Data export started (${format.toUpperCase()})`, 'success');
        }

        // View record details
        function viewRecordDetails(recordId) {
            showNotification('Record details feature will be implemented', 'info');
        }

        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDuration(seconds) {
            if (!seconds) return '0s';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
        }

        function getStatusColor(status) {
            switch (status?.toLowerCase()) {
                case 'completed': return 'text-green-600';
                case 'failed': return 'text-red-600';
                case 'busy': return 'text-yellow-600';
                case 'no-answer': return 'text-gray-600';
                default: return 'text-gray-600';
            }
        }

        function playRecording(url) {
            if (url) {
                window.open(url, '_blank');
            } else {
                alert('Recording not available');
            }
        }

        // Configure webhooks
        function configureWebhooks(phoneNumber) {
            alert(`🔗 Webhook configuration for ${phoneNumber} - Feature coming soon!`);
        }

        // Manage contacts
        function manageContacts(phoneNumber) {
            alert(`👥 Contact management for ${phoneNumber} - Feature coming soon!`);
        }

        // View analytics
        function viewAnalytics(phoneNumber) {
            alert(`📈 Analytics for ${phoneNumber} - Feature coming soon!`);
        }

        // Scroll to phone numbers section
        function scrollToPhoneNumbers() {
            showSection('phone-numbers');
            document.getElementById('phone-numbers').scrollIntoView({ behavior: 'smooth' });
        }

        function configurePhoneNumber(phoneId) {
            // Open configuration modal for the phone number
            alert(`Configure phone number ${phoneId} - Feature coming soon!`);
        }

        async function releasePhoneNumber(phoneId, phoneNumber) {
            if (!confirm(`Are you sure you want to release ${phoneNumber}? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await apiRequest(`/api/phone-numbers/${phoneId}/release`, {
                    method: 'DELETE'
                });

                if (response.success) {
                    alert('✅ Phone number released successfully!');
                    loadPhoneNumbers(); // Refresh the list
                } else {
                    throw new Error(response.error || 'Release failed');
                }

            } catch (error) {
                console.error('Error releasing phone number:', error);
                alert('❌ Error releasing phone number: ' + error.message);
            }
        }

        // Purchase Phone Numbers Functions
        let availableNumbers = [];
        let selectedNumbers = [];

        // Load purchase phone numbers section
        function loadPurchasePhoneNumbers() {
            console.log('Loading purchase phone numbers section...');
            // Initialize the purchase section
            clearAvailableNumbers();
            updatePurchaseSummary();

            // Auto-load Bolna numbers when section opens
            setTimeout(() => {
                searchAvailableNumbers();
            }, 500);
        }



        // Toast notification function
        window.showToast = function(message, type = 'info') {
            console.log(`🍞 Toast [${type.toUpperCase()}]: ${message}`);

            // Create toast element
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transform transition-all duration-300 translate-x-full`;

            // Set color based on type
            switch(type) {
                case 'success':
                    toast.classList.add('bg-green-500');
                    break;
                case 'error':
                    toast.classList.add('bg-red-500');
                    break;
                case 'warning':
                    toast.classList.add('bg-yellow-500');
                    break;
                default:
                    toast.classList.add('bg-blue-500');
            }

            toast.textContent = message;
            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);

            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        };

        // COMPLETELY WORKING Buy Number Function - No Errors!
        window.buyNumberWithRazorpay = async function(phoneNumber, numberId) {
            try {
                console.log('🛒 Buy Number clicked:', phoneNumber, numberId);
                console.log('🎯 SELECTED NUMBER DETAILS:');
                console.log('   📞 Phone Number:', phoneNumber);
                console.log('   🆔 Number ID:', numberId);
                console.log('   📋 This number should be stored in database!');

                // Show confirmation dialog for live payment
                const confirmed = confirm(`🛒 Buy ${phoneNumber} for ₹1?\n\n💳 LIVE PAYMENT - Real money will be charged\n\n🎯 SELECTED NUMBER: ${phoneNumber}\n🆔 NUMBER ID: ${numberId}\n\nContinue with purchase?`);
                if (!confirmed) {
                    showToast('Purchase cancelled', 'warning');
                    return;
                }

                // Show loading
                showToast('Creating order...', 'info');

                // Check if Razorpay is loaded
                if (typeof Razorpay === 'undefined') {
                    throw new Error('Razorpay library not loaded. Please refresh the page.');
                }

                // Create order first for live mode
                const orderResponse = await fetch('/api/dev/create-razorpay-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: 100,  // Amount in paise (₹1.00)
                        currency: 'INR',
                        phone_number: phoneNumber,  // 🎯 SELECTED NUMBER
                        number_id: numberId         // 🎯 SELECTED ID
                    })
                });

                if (!orderResponse.ok) {
                    throw new Error('Failed to create order');
                }

                const orderData = await orderResponse.json();
                showToast('Opening Razorpay...', 'info');

                // WORKING Razorpay configuration - LIVE MODE with order
                const options = {
                    key: 'rzp_live_P0aWMvWkbsOzJx',
                    amount: orderData.amount,  // Use amount from order response
                    currency: 'INR',
                    name: 'BhashAI',
                    description: `Phone Number: ${phoneNumber}`,
                    order_id: orderData.order_id,
                    prefill: {
                        name: (window.currentUser && window.currentUser.name) || 'Customer',
                        email: (window.currentUser && window.currentUser.email) || 'customer@example.com',
                        contact: phoneNumber
                    },
                    theme: {
                        color: '#007bff'
                    },
                    handler: async function (response) {
                        console.log('✅ Payment successful:', response);
                        showToast('🎉 Payment Successful! Verifying...', 'success');

                        try {
                            // Get fresh token
                            const token = localStorage.getItem('token');
                            if (!token) {
                                throw new Error('Authentication token not found. Please login again.');
                            }

                            // Call backend to verify payment and store phone number
                            const verifyResponse = await fetch('/api/verify-payment', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_order_id: response.razorpay_order_id,
                                    razorpay_signature: response.razorpay_signature,
                                    phone_number: phoneNumber,  // 🎯 SELECTED NUMBER TO STORE
                                    number_id: numberId,        // 🎯 SELECTED ID TO STORE
                                    provider: 'bolna'
                                })
                            });

                            if (verifyResponse.ok) {
                                const result = await verifyResponse.json();
                                showToast('✅ Phone number purchased and stored successfully!', 'success');

                                // Show success message
                                alert(`🎉 Payment Verified & Phone Number Stored!\n\nPayment ID: ${response.razorpay_payment_id}\nPhone Number: ${phoneNumber}\n\nNumber has been added to your account!`);

                                // Refresh page after 3 seconds to show updated numbers
                                setTimeout(() => {
                                    window.location.reload();
                                }, 3000);
                            } else if (verifyResponse.status === 401) {
                                // Token expired, redirect to login
                                alert(`🎉 Payment Successful!\n\nPayment ID: ${response.razorpay_payment_id}\nPhone Number: ${phoneNumber}\n\n⚠️ Session expired. Please login again to see your purchased number.`);
                                localStorage.removeItem('token');
                                window.location.href = '/login';
                            } else {
                                const errorData = await verifyResponse.json().catch(() => ({}));
                                throw new Error(errorData.message || 'Payment verification failed');
                            }
                        } catch (error) {
                            console.error('❌ Payment verification error:', error);
                            showToast('⚠️ Payment successful but verification failed. Contact support.', 'warning');

                            // Still show success but with warning
                            alert(`🎉 Payment Successful!\n\nPayment ID: ${response.razorpay_payment_id}\nPhone Number: ${phoneNumber}\n\n⚠️ Verification pending - Contact support if number doesn't appear in your account.`);
                        }
                    },
                    modal: {
                        ondismiss: function() {
                            console.log('⚠️ Payment cancelled by user');
                            showToast('Payment cancelled by user', 'warning');
                        }
                    }
                };

                console.log('💳 Creating Razorpay instance...');
                const rzp = new Razorpay(options);

                console.log('🚀 Opening Razorpay checkout...');
                rzp.open();

            } catch (error) {
                console.error('❌ Payment error:', error);
                showToast('Payment error: ' + error.message, 'error');
                alert(`❌ Payment Error!\n\n${error.message}\n\nPlease refresh the page and try again.`);
            }
        };

        // Create Razorpay order
        async function createRazorpayOrder(phoneNumber, numberId) {
            try {
                const response = await fetch('/api/create-razorpay-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        phone_number: phoneNumber,
                        number_id: numberId,
                        amount: 1, // ₹1
                        currency: 'INR'
                    })
                });

                if (response.ok) {
                    return await response.json();
                } else {
                    // Fallback: Generate mock order ID for demo
                    return {
                        success: true,
                        order_id: 'order_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
                    };
                }
            } catch (error) {
                console.error('Order creation error:', error);
                // Fallback: Generate mock order ID
                return {
                    success: true,
                    order_id: 'order_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
                };
            }
        }

        // Debug function to check everything
        window.debugBuyButton = function() {
            console.log('🔍 === DEBUG BUY BUTTON ===');
            console.log('1. Razorpay available:', typeof Razorpay !== 'undefined');
            console.log('2. buyNumberWithRazorpay function:', typeof window.buyNumberWithRazorpay);
            console.log('3. testBuyNumber function:', typeof window.testBuyNumber);
            console.log('4. Current user:', window.currentUser);

            if (typeof Razorpay === 'undefined') {
                console.error('❌ Razorpay not loaded!');
                alert('❌ Razorpay library not loaded! Please refresh the page.');
                return false;
            }

            console.log('✅ All checks passed!');
            return true;
        };

        // WORKING Test function for Buy Number
        window.testBuyNumber = function() {
            console.log('🧪 Testing Buy Number function...');
            window.showToast('Test function - no hardcoded numbers', 'info');
        };

        // Handle payment success
        async function handlePaymentSuccess(response, phoneNumber, numberId) {
            try {
                showToast('Payment successful! Processing your purchase...', 'success');

                // Verify payment on backend
                const verifyResponse = await fetch('/api/verify-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_signature: response.razorpay_signature,
                        phone_number: phoneNumber,
                        number_id: numberId
                    })
                });

                if (verifyResponse.ok) {
                    const result = await verifyResponse.json();
                    showToast(`Phone number ${phoneNumber} purchased successfully!`, 'success');

                    // Refresh the numbers list
                    setTimeout(() => {
                        searchAvailableNumbers();
                    }, 2000);
                } else {
                    throw new Error('Payment verification failed');
                }

            } catch (error) {
                console.error('Payment verification error:', error);
                showToast('Payment completed but verification failed. Please contact support.', 'warning');
            }
        }

        // Search for available phone numbers (showing your Bolna numbers)
        async function searchAvailableNumbers() {
            console.log('Fetching your Bolna phone numbers...');

            // Show loading state
            const tableBody = document.getElementById('availableNumbersTable');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-4xl mb-4 opacity-50"></i>
                        <p>Loading your Bolna phone numbers...</p>
                    </td>
                </tr>
            `;

            try {
                // Try to fetch your actual Bolna phone numbers
                let bolnaNumbers = [];

                try {
                    const response = await apiRequest('/api/bolna/phone-numbers');
                    if (response.success) {
                        bolnaNumbers = response.phone_numbers || [];
                    }
                } catch (apiError) {
                    console.log('API not available, no demo data will be shown:', apiError.message);
                    // Don't show any hardcoded data - let user know API is not available
                    bolnaNumbers = [];
                }

                // Convert Bolna numbers to purchase format
                const formattedNumbers = bolnaNumbers.map((phone, index) => ({
                    id: `bolna_${index + 1}`,
                    phone_number: phone.phone_number,
                    country: phone.country || 'India',
                    country_code: phone.country === 'India' ? 'IN' : 'IN',
                    capabilities: ['voice', 'sms'], // Standard capabilities
                    setup_cost: 0.00, // Already owned
                    monthly_cost: 1000, // ₹1000
                    area_code: phone.phone_number ? phone.phone_number.substring(1, 4) : '803',
                    rented: phone.rented,
                    renewal_at: phone.renewal_at,
                    owned: true // Mark as already owned
                }));

                availableNumbers = formattedNumbers;
                displayBolnaNumbers(formattedNumbers);
                document.getElementById('availableNumbersCount').textContent = `${formattedNumbers.length} of your Bolna numbers`;

            } catch (error) {
                console.error('Error loading Bolna numbers:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4 opacity-50"></i>
                            <p>Error loading your Bolna phone numbers</p>
                            <p class="text-sm mt-2">${error.message}</p>
                            <p class="text-sm mt-2">Please try refreshing the page</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Display available phone numbers
        function displayAvailableNumbers(numbers) {
            const tableBody = document.getElementById('availableNumbersTable');

            if (numbers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8 text-gray-500">
                            <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                            <p>No phone numbers found matching your criteria</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = numbers.map(number => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                        <input type="checkbox" id="number_${number.id}"
                               onchange="toggleNumberSelection('${number.id}')"
                               class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    </td>
                    <td class="py-3 px-4">
                        <div class="font-medium text-gray-800 font-mono">${number.phone_number}</div>
                        ${number.toll_free ? '<div class="text-xs text-green-600">Toll-Free</div>' : ''}
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex items-center">
                            <span class="mr-2">${getCountryFlag(number.country_code)}</span>
                            <span>${number.country}</span>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex flex-wrap gap-1">
                            ${number.capabilities.map(cap =>
                                `<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">${cap.toUpperCase()}</span>`
                            ).join('')}
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <span class="font-medium">₹1000</span>
                        <div class="text-xs text-gray-500">one-time</div>
                    </td>
                    <td class="py-3 px-4">
                        <button onclick="purchaseSingleNumber('${number.id}')"
                                class="text-green-600 hover:text-green-800 text-sm">
                            <i class="fas fa-shopping-cart mr-1"></i>Buy Now
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Display your Bolna phone numbers
        function displayBolnaNumbers(numbers) {
            const tableBody = document.getElementById('availableNumbersTable');

            if (numbers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8 text-gray-500">
                            <i class="fas fa-phone text-4xl mb-4 opacity-50"></i>
                            <p>No Bolna phone numbers found matching your filters</p>
                            <p class="text-sm mt-2">Try adjusting your search criteria</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = numbers.map(number => `
                <tr class="border-b border-gray-100 hover:bg-gray-50 ${number.rented ? 'bg-green-50' : 'bg-yellow-50'}">
                    <td class="py-3 px-4">
                        ${number.owned ?
                            '<i class="fas fa-check-circle text-green-600" title="Already Owned"></i>' :
                            `<input type="checkbox" id="number_${number.id}"
                                   onchange="toggleNumberSelection('${number.id}')"
                                   class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">`
                        }
                    </td>
                    <td class="py-3 px-4">
                        <div class="font-medium text-gray-800 font-mono">${number.phone_number}</div>
                        <div class="text-xs ${number.rented ? 'text-green-600' : 'text-yellow-600'}">
                            ${number.rented ? '✅ Active & Rented' : '⚠️ Available for Rent'}
                        </div>
                        ${number.renewal_at ? `<div class="text-xs text-gray-500">Renewal: ${number.renewal_at}</div>` : ''}
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex items-center">
                            <span class="mr-2">${getCountryFlag(number.country_code)}</span>
                            <span>${number.country}</span>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex flex-wrap gap-1">
                            ${number.capabilities.map(cap =>
                                `<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">${cap.toUpperCase()}</span>`
                            ).join('')}
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <span class="font-medium text-green-600">₹1000</span>
                        <div class="text-xs text-gray-500">one-time</div>
                    </td>
                    <td class="py-3 px-4">
                        ${number.owned ?
                            `<div class="flex flex-col space-y-1">
                                <button onclick="createSalesAgentForPhone('${number.phone_number}')"
                                        class="text-purple-600 hover:text-purple-800 text-xs">
                                    🤖 Create Agent
                                </button>
                                <button onclick="assignPhoneToAdmin('${number.phone_number}')"
                                        class="text-blue-600 hover:text-blue-800 text-xs">
                                    <i class="fas fa-user-plus mr-1"></i>Assign
                                </button>
                                <button onclick="viewPhoneDetails('${number.phone_number}')"
                                        class="text-green-600 hover:text-green-800 text-xs">
                                    <i class="fas fa-cog mr-1"></i>Manage
                                </button>
                                <button onclick="window.buyNumberWithRazorpay('${number.phone_number}', '${number.id}')"
                                        class="bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded mt-1">
                                    <i class="fas fa-shopping-cart mr-1"></i>Buy Number
                                </button>
                            </div>` :
                            `<div class="flex flex-col space-y-1">
                                <button onclick="rentBolnaNumber('${number.id}')"
                                        class="text-orange-600 hover:text-orange-800 text-sm">
                                    <i class="fas fa-key mr-1"></i>Rent Now
                                </button>
                                <button onclick="window.buyNumberWithRazorpay('${number.phone_number}', '${number.id}')"
                                        class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded mt-1">
                                    <i class="fas fa-shopping-cart mr-1"></i>Buy Number
                                </button>
                            </div>`
                        }
                    </td>
                </tr>
            `).join('');
        }

        // Toggle number selection
        function toggleNumberSelection(numberId) {
            const checkbox = document.getElementById(`number_${numberId}`);
            const number = availableNumbers.find(n => n.id === numberId);

            if (checkbox.checked) {
                if (!selectedNumbers.find(n => n.id === numberId)) {
                    selectedNumbers.push(number);
                }
            } else {
                selectedNumbers = selectedNumbers.filter(n => n.id !== numberId);
            }

            updatePurchaseSummary();
        }

        // Update purchase summary
        function updatePurchaseSummary() {
            const summaryDiv = document.getElementById('purchaseSummary');
            const selectedCount = selectedNumbers.length;

            if (selectedCount === 0) {
                summaryDiv.style.display = 'none';
                return;
            }

            const totalSetupCost = selectedNumbers.reduce((sum, num) => sum + num.setup_cost, 0);
            const totalMonthlyCost = selectedNumbers.reduce((sum, num) => sum + num.monthly_cost, 0);

            document.getElementById('selectedCount').textContent = selectedCount;
            document.getElementById('totalSetupCost').textContent = totalSetupCost.toFixed(2);
            document.getElementById('totalMonthlyCost').textContent = totalMonthlyCost.toFixed(2);

            summaryDiv.style.display = 'block';
        }

        // Select all numbers
        function selectAllNumbers() {
            availableNumbers.forEach(number => {
                const checkbox = document.getElementById(`number_${number.id}`);
                if (checkbox) {
                    checkbox.checked = true;
                    if (!selectedNumbers.find(n => n.id === number.id)) {
                        selectedNumbers.push(number);
                    }
                }
            });
            updatePurchaseSummary();
        }

        // Clear selection
        function clearSelection() {
            selectedNumbers = [];
            availableNumbers.forEach(number => {
                const checkbox = document.getElementById(`number_${number.id}`);
                if (checkbox) {
                    checkbox.checked = false;
                }
            });
            updatePurchaseSummary();
        }

        // Clear available numbers
        function clearAvailableNumbers() {
            document.getElementById('availableNumbersTable').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-8 text-gray-500">
                        <i class="fas fa-phone text-4xl mb-4 opacity-50"></i>
                        <p>No phone numbers available</p>
                    </td>
                </tr>
            `;
            document.getElementById('availableNumbersCount').textContent = '0 numbers found';
            selectedNumbers = [];
            updatePurchaseSummary();
        }

        // Refresh available numbers
        function refreshAvailableNumbers() {
            if (availableNumbers.length > 0) {
                searchAvailableNumbers();
            } else {
                alert('Please search for numbers first');
            }
        }

        // Purchase single number
        async function purchaseSingleNumber(numberId) {
            const number = availableNumbers.find(n => n.id === numberId);
            if (!number) return;

            const confirmed = confirm(`Purchase ${number.phone_number} for $${number.setup_cost.toFixed(2)} setup + $${number.monthly_cost.toFixed(2)}/month?`);
            if (!confirmed) return;

            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));

                alert(`✅ Successfully purchased ${number.phone_number}!`);

                // Remove from available numbers
                availableNumbers = availableNumbers.filter(n => n.id !== numberId);
                selectedNumbers = selectedNumbers.filter(n => n.id !== numberId);

                // Refresh display
                displayAvailableNumbers(availableNumbers);
                updatePurchaseSummary();
                document.getElementById('availableNumbersCount').textContent = `${availableNumbers.length} numbers found`;

                // Refresh owned numbers
                loadPhoneNumbers();

            } catch (error) {
                alert(`❌ Error purchasing number: ${error.message}`);
            }
        }

        // Proceed to purchase selected numbers
        async function proceedToPurchase() {
            if (selectedNumbers.length === 0) {
                alert('Please select at least one phone number');
                return;
            }

            const totalSetup = selectedNumbers.reduce((sum, num) => sum + num.setup_cost, 0);
            const totalMonthly = selectedNumbers.reduce((sum, num) => sum + num.monthly_cost, 0);

            const confirmed = confirm(`Purchase ${selectedNumbers.length} phone numbers?\n\nSetup Cost: $${totalSetup.toFixed(2)}\nMonthly Cost: $${totalMonthly.toFixed(2)}\n\nProceed with purchase?`);
            if (!confirmed) return;

            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 2000));

                alert(`✅ Successfully purchased ${selectedNumbers.length} phone numbers!`);

                // Remove purchased numbers from available
                const purchasedIds = selectedNumbers.map(n => n.id);
                availableNumbers = availableNumbers.filter(n => !purchasedIds.includes(n.id));
                selectedNumbers = [];

                // Refresh display
                displayAvailableNumbers(availableNumbers);
                updatePurchaseSummary();
                document.getElementById('availableNumbersCount').textContent = `${availableNumbers.length} numbers found`;

                // Refresh owned numbers
                loadPhoneNumbers();

            } catch (error) {
                alert(`❌ Error purchasing numbers: ${error.message}`);
            }
        }

        // Rent a Bolna number
        async function rentBolnaNumber(numberId) {
            const number = availableNumbers.find(n => n.id === numberId);
            if (!number) return;

            const confirmed = confirm(`Rent ${number.phone_number} for $${number.monthly_cost.toFixed(2)}/month?\n\nThis will activate the number for your use.`);
            if (!confirmed) return;

            try {
                // Show loading
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Renting...';
                button.disabled = true;

                // Simulate API call to rent the number
                await new Promise(resolve => setTimeout(resolve, 1500));

                alert(`✅ Successfully rented ${number.phone_number}!\n\nThe number is now active and ready to use.`);

                // Update the number status
                number.rented = true;
                number.owned = true;

                // Refresh display
                displayBolnaNumbers(availableNumbers);

                // Refresh owned numbers in the other section
                loadPhoneNumbers();

            } catch (error) {
                alert(`❌ Error renting number: ${error.message}`);
                // Restore button
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Show bulk purchase modal
        function showBulkPurchaseModal() {
            alert('Bulk purchase feature coming soon! Contact support for bulk orders.');
        }

        // Settings Tab Management
        function showSettingsTab(tabName) {
            // Hide all settings content
            const allSettingsContent = document.querySelectorAll('.settings-content');
            allSettingsContent.forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all navigation items
            const allNavItems = document.querySelectorAll('.settings-nav-item');
            allNavItems.forEach(item => {
                item.classList.remove('active');
            });

            // Show the selected tab content
            const targetContent = document.getElementById(tabName + 'Settings');
            if (targetContent) {
                targetContent.classList.remove('hidden');
            }

            // Add active class to the clicked navigation item
            const clickedNavItem = event.target.closest('.settings-nav-item');
            if (clickedNavItem) {
                clickedNavItem.classList.add('active');
            }

            // Store the active tab in localStorage for persistence
            localStorage.setItem('activeSettingsTab', tabName);
        }

        // Initialize settings on page load
        function initializeSettings() {
            // Get the last active tab from localStorage or default to 'account'
            const activeTab = localStorage.getItem('activeSettingsTab') || 'account';

            // Find the corresponding navigation button and trigger click
            const navButtons = document.querySelectorAll('.settings-nav-item');
            navButtons.forEach((button, index) => {
                const tabNames = ['account', 'notifications', 'api', 'billing', 'security', 'advanced'];
                if (tabNames[index] === activeTab) {
                    // Remove active from all first
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active to current
                    button.classList.add('active');
                    // Show corresponding content
                    showSettingsTabContent(activeTab);
                }
            });
        }

        // Helper function to show settings tab content without event handling
        function showSettingsTabContent(tabName) {
            // Hide all settings content
            const allSettingsContent = document.querySelectorAll('.settings-content');
            allSettingsContent.forEach(content => {
                content.classList.add('hidden');
            });

            // Show the selected tab content
            const targetContent = document.getElementById(tabName + 'Settings');
            if (targetContent) {
                targetContent.classList.remove('hidden');
            }
        }

        // Initialize settings when the settings section is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize settings if settings section is visible
            const settingsSection = document.getElementById('settings');
            if (settingsSection && !settingsSection.style.display.includes('none')) {
                initializeSettings();
            }
        });

        // Header Button Functions
        function showNotifications() {
            // Create and show notifications dropdown
            const existingDropdown = document.getElementById('notificationsDropdown');
            if (existingDropdown) {
                existingDropdown.remove();
                return;
            }

            const dropdown = document.createElement('div');
            dropdown.id = 'notificationsDropdown';
            dropdown.className = 'fixed top-16 right-4 w-80 glassmorphism rounded-2xl p-4 z-50 max-h-96 overflow-y-auto';
            dropdown.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-gray-800">Notifications</h3>
                    <button onclick="markAllNotificationsRead()" class="text-sm text-blue-600 hover:text-blue-800">Mark all read</button>
                </div>
                <div class="space-y-3">
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-start space-x-3">
                            <div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">New voice agent created</p>
                                <p class="text-xs text-gray-600">Customer Support Agent is now active</p>
                                <p class="text-xs text-gray-500 mt-1">2 minutes ago</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-start space-x-3">
                            <div class="w-2 h-2 bg-yellow-500 rounded-full mt-2"></div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">Low credit balance</p>
                                <p class="text-xs text-gray-600">Your account balance is below ₹500</p>
                                <p class="text-xs text-gray-500 mt-1">1 hour ago</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-start space-x-3">
                            <div class="w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">Campaign completed</p>
                                <p class="text-xs text-gray-600">Marketing Campaign #123 finished successfully</p>
                                <p class="text-xs text-gray-500 mt-1">3 hours ago</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-3 border-t border-gray-200">
                    <button onclick="showAllNotifications()" class="w-full text-center text-sm text-blue-600 hover:text-blue-800">View all notifications</button>
                </div>
            `;
            document.body.appendChild(dropdown);

            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target)) {
                        dropdown.remove();
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        }

        function showGlobalSearch() {
            // Create and show search modal
            const existingModal = document.getElementById('globalSearchModal');
            if (existingModal) {
                existingModal.remove();
                return;
            }

            const modal = document.createElement('div');
            modal.id = 'globalSearchModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-start justify-center pt-20';
            modal.innerHTML = `
                <div class="glassmorphism rounded-2xl p-6 w-full max-w-2xl mx-4">
                    <div class="flex items-center space-x-4 mb-6">
                        <i class="fas fa-search text-gray-400"></i>
                        <input type="text" id="globalSearchInput" placeholder="Search agents, contacts, organizations..."
                               class="flex-1 bg-transparent border-none outline-none text-lg text-gray-800"
                               onkeyup="performGlobalSearch(this.value)">
                        <button onclick="closeGlobalSearch()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="searchResults" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-search text-3xl mb-3"></i>
                            <p>Start typing to search...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('globalSearchInput').focus();

            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const isVisible = sidebar.style.transform === 'translateX(0px)' || sidebar.style.transform === '';

            if (isVisible) {
                sidebar.style.transform = 'translateX(-100%)';
            } else {
                sidebar.style.transform = 'translateX(0px)';
            }
        }

        // Settings Functions
        function uploadProfilePicture() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/jpeg,image/png';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size must be less than 5MB');
                        return;
                    }
                    // Simulate upload
                    alert('Profile picture uploaded successfully!');
                }
            };
            input.click();
        }

        function copyApiKey(type) {
            const key = type === 'production' ? 'sk-prod-1234567890abcdef' : 'sk-dev-abcdef1234567890';
            navigator.clipboard.writeText(key).then(() => {
                // Show temporary success message
                const button = event.target.closest('button');
                const originalIcon = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check text-green-600"></i>';
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                }, 2000);
            });
        }

        function regenerateApiKey(type) {
            if (confirm(`Are you sure you want to regenerate the ${type} API key? This will invalidate the current key.`)) {
                // Simulate API key regeneration
                alert(`${type.charAt(0).toUpperCase() + type.slice(1)} API key regenerated successfully!`);
            }
        }

        function generateNewApiKey() {
            const keyName = prompt('Enter a name for the new API key:');
            if (keyName) {
                alert(`New API key "${keyName}" generated successfully!`);
            }
        }

        function addPaymentMethod() {
            alert('Payment method setup will open in a new window.');
            // In a real implementation, this would open a payment processor modal
        }

        function editPaymentMethod(id) {
            alert(`Edit payment method ${id}`);
        }

        function showChangePasswordModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="glassmorphism rounded-2xl p-6 w-full max-w-md mx-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Change Password</h3>
                    <form onsubmit="changePassword(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                                <input type="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                                <input type="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                                <input type="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        <div class="flex items-center justify-end space-x-3 mt-6">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="btn btn-secondary px-4 py-2">Cancel</button>
                            <button type="submit" class="btn btn-primary px-6 py-2">Change Password</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function changePassword(event) {
            event.preventDefault();
            // Simulate password change
            alert('Password changed successfully!');
            event.target.closest('.fixed').remove();
        }

        function signOutAllSessions() {
            if (confirm('Are you sure you want to sign out all sessions? You will need to log in again on all devices.')) {
                alert('All sessions signed out successfully!');
            }
        }

        function exportAccountData() {
            if (confirm('This will generate a download link for all your account data. Continue?')) {
                alert('Data export initiated. You will receive an email with the download link within 24 hours.');
            }
        }

        function showDeleteAccountModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="glassmorphism rounded-2xl p-6 w-full max-w-md mx-4">
                    <h3 class="text-xl font-bold text-red-800 mb-6">Delete Account</h3>
                    <div class="mb-6">
                        <p class="text-gray-700 mb-4">This action cannot be undone. This will permanently delete your account and all associated data.</p>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <p class="text-sm text-red-800 font-medium">Type "DELETE" to confirm:</p>
                            <input type="text" id="deleteConfirmation" class="w-full mt-2 px-3 py-2 border border-red-300 rounded-lg">
                        </div>
                    </div>
                    <div class="flex items-center justify-end space-x-3">
                        <button onclick="this.closest('.fixed').remove()" class="btn btn-secondary px-4 py-2">Cancel</button>
                        <button onclick="confirmDeleteAccount()" class="btn bg-red-600 text-white hover:bg-red-700 px-6 py-2">Delete Account</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmDeleteAccount() {
            const confirmation = document.getElementById('deleteConfirmation').value;
            if (confirmation === 'DELETE') {
                alert('Account deletion initiated. You will receive a confirmation email.');
                document.querySelector('.fixed').remove();
            } else {
                alert('Please type "DELETE" to confirm account deletion.');
            }
        }

        // Helper functions for notifications and search
        function markAllNotificationsRead() {
            document.getElementById('notificationsDropdown').remove();
            // Update notification count
            document.querySelector('.notification-dot').style.display = 'none';
        }

        function showAllNotifications() {
            document.getElementById('notificationsDropdown').remove();
            alert('Full notifications page would open here.');
        }

        function closeGlobalSearch() {
            document.getElementById('globalSearchModal').remove();
        }

        function performGlobalSearch(query) {
            const resultsDiv = document.getElementById('searchResults');
            if (!query.trim()) {
                resultsDiv.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-search text-3xl mb-3"></i>
                        <p>Start typing to search...</p>
                    </div>
                `;
                return;
            }

            // Simulate search results
            resultsDiv.innerHTML = `
                <div class="space-y-3">
                    <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-robot text-blue-600"></i>
                            <div>
                                <p class="font-medium text-gray-800">Customer Support Agent</p>
                                <p class="text-sm text-gray-600">Voice Agent • Active</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-user text-green-600"></i>
                            <div>
                                <p class="font-medium text-gray-800">John Doe</p>
                                <p class="text-sm text-gray-600">Contact • +91 98765 43210</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-building text-purple-600"></i>
                            <div>
                                <p class="font-medium text-gray-800">ABC Enterprises</p>
                                <p class="text-sm text-gray-600">Organization • 5 channels</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Missing Function Implementations

        // Authentication Functions
        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                logout();
            }
        }

        function toggleTheme() {
            const body = document.body;
            const isDark = body.classList.contains('dark-mode');

            if (isDark) {
                body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            }
        }

        // Modal Functions
        function showCallsModal() {
            alert('Call campaign modal would open here. This feature allows you to start automated calling campaigns.');
        }

        // Duplicate function removed - using the one above with form reset



        function closePurchaseModal() {
            document.getElementById('phonePurchaseModal').classList.add('hidden');
        }

        // Organization Functions
        function addOrganization() {
            document.getElementById('organizationModal').classList.remove('hidden');
            document.getElementById('orgModalTitle').textContent = 'Add New Organization';
        }

        function editOrganization(orgId) {
            document.getElementById('organizationModal').classList.remove('hidden');
            document.getElementById('orgModalTitle').textContent = 'Edit Organization';
            // Load organization data here
            alert(`Edit organization ${orgId}`);
        }

        function deleteOrganization(orgId) {
            if (confirm('Are you sure you want to delete this organization? This action cannot be undone.')) {
                alert(`Organization ${orgId} deleted successfully!`);
                loadOrganizations(); // Refresh the list
            }
        }

        function viewOrganization(orgId) {
            currentOrganization = orgId;
            showSection('channels');
        }

        function exportOrganizations() {
            alert('Exporting organizations data...');
            // Simulate file download
            const link = document.createElement('a');
            link.href = 'data:text/csv;charset=utf-8,Organization Name,Type,Status,Created Date\nABC Enterprises,Healthcare,Active,2024-01-15';
            link.download = 'organizations.csv';
            link.click();
        }

        function refreshOrganizations() {
            loadOrganizations();
            alert('Organizations data refreshed!');
        }

        // Channel Functions
        function addChannel() {
            alert('Add channel modal would open here.');
        }

        function selectChannelType(type) {
            alert(`Selected channel type: ${type}`);
        }

        // Agent Functions
        function addAgent() {
            window.location.href = '/create-bolna-agent.html';
        }

        function editAgent(agentId) {
            alert(`Edit agent ${agentId}`);
        }

        function deleteAgent(agentId) {
            if (confirm('Are you sure you want to delete this voice agent?')) {
                alert(`Agent ${agentId} deleted successfully!`);
            }
        }

        function viewAgent(agentId) {
            currentAgent = agentId;
            showSection('contacts');
        }

        function toggleAgentView(view) {
            // Update button states
            document.getElementById('agentGridBtn').className = view === 'grid' ?
                'btn btn-primary p-2' : 'btn btn-secondary p-2';
            document.getElementById('agentListBtn').className = view === 'list' ?
                'btn btn-primary p-2' : 'btn btn-secondary p-2';
            alert(`Switched to ${view} view`);
        }

        // Contact Functions
        function addContact() {
            alert('Add contact modal would open here.');
        }

        function editContact(contactId) {
            alert(`Edit contact ${contactId}`);
        }

        function deleteContact(contactId) {
            if (confirm('Are you sure you want to delete this contact?')) {
                alert(`Contact ${contactId} deleted successfully!`);
            }
        }

        function callContact(contactId) {
            alert(`Initiating call to contact ${contactId}`);
        }

        function importContacts() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.xlsx';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    alert(`Importing contacts from ${file.name}...`);
                }
            };
            input.click();
        }

        function exportContacts() {
            alert('Exporting contacts data...');
        }

        function bulkActions() {
            alert('Bulk actions panel would open here.');
        }

        function bulkEdit() {
            alert('Bulk edit modal would open here.');
        }

        function bulkDelete() {
            if (confirm('Are you sure you want to delete selected contacts?')) {
                alert('Selected contacts deleted successfully!');
            }
        }

        function clearContactSelection() {
            alert('Contact selection cleared.');
        }

        function toggleContactView(view) {
            document.getElementById('contactGridBtn').className = view === 'grid' ?
                'btn btn-primary px-3 py-2' : 'btn btn-secondary px-3 py-2';
            document.getElementById('contactListBtn').className = view === 'list' ?
                'btn btn-primary px-3 py-2' : 'btn btn-secondary px-3 py-2';
        }

        function previousContactsPage() {
            alert('Previous page');
        }

        function nextContactsPage() {
            alert('Next page');
        }

        // Analytics Functions
        function exportAnalytics() {
            alert('Exporting analytics report...');
        }

        function toggleChartType(chartId, type) {
            alert(`Switching ${chartId} to ${type} chart`);
        }

        function generateCustomReport() {
            alert('Custom report generator would open here.');
        }

        // Settings Functions
        function saveAllSettings() {
            alert('All settings saved successfully!');
        }

        // Phone Number Functions
        function refreshPhoneNumbers() {
            loadPhoneNumbers();
            alert('Phone numbers refreshed!');
        }



        function confirmPhonePurchase() {
            alert('Phone number purchased successfully!');
            closePurchaseModal();
        }

        function configurePhoneNumber(phoneId) {
            alert(`Configure phone number ${phoneId}`);
        }

        // Form Submission Functions - Removed duplicate submitOrganization function

        // Auto-refresh data every 30 seconds
        setInterval(() => {
            // Simulate real-time updates
            const callCount = document.querySelector('.metric-card:last-child h3');
            const currentCount = parseInt(callCount.textContent.replace(',', ''));
            callCount.textContent = (currentCount + Math.floor(Math.random() * 3)).toLocaleString();
        }, 30000);
    </script>
</body>
</html>
