<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Setup - BhashAI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .agent-info {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .agent-info h3 {
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .agent-info p {
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .tabs {
            display: flex;
            margin-bottom: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 5px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 10px 15px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <a href="/dashboard.html" class="back-btn">
        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
    </a>

    <div class="container">
        <div class="header">
            <h1>ü§ñ Agent Setup</h1>
            <p>Configure your AI agent for phone number communication</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="agent-info">
                    <h3>üìû Phone Number</h3>
                    <p id="phoneNumber">Loading...</p>
                    <h3 style="margin-top: 15px;">üÜî Agent ID</h3>
                    <p id="agentId">Not Assigned</p>
                </div>

                <div class="form-group">
                    <label>Agent Name</label>
                    <input type="text" class="form-control" id="agentName" placeholder="Sales Expert - ‡§∞‡§æ‡§ú">
                </div>

                <div class="form-group">
                    <label>Agent Type</label>
                    <select class="form-control" id="agentType">
                        <option value="sales">Sales Agent</option>
                        <option value="support">Support Agent</option>
                        <option value="reminder">Reminder Agent</option>
                        <option value="general">General Inquiry</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Voice</label>
                    <select class="form-control" id="voice">
                        <option value="Aditi">Aditi (Hindi Female)</option>
                        <option value="Raveena">Raveena (Hindi Female)</option>
                        <option value="Kajal">Kajal (Hindi Female)</option>
                        <option value="Aria">Aria (English Female)</option>
                        <option value="Matthew">Matthew (English Male)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Language</label>
                    <select class="form-control" id="language">
                        <option value="hi">Hindi</option>
                        <option value="en">English</option>
                        <option value="hi-en">Hindi + English</option>
                    </select>
                </div>
            </div>

            <div class="content-area">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('welcome')">Welcome Message</div>
                    <div class="tab" onclick="switchTab('prompt')">Agent Prompt</div>
                </div>

                <div id="welcomeTab" class="tab-content active">
                    <div class="form-group">
                        <label>Agent Welcome Message</label>
                        <textarea class="form-control" id="welcomeMessage" placeholder="‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§∞‡§æ‡§ú ‡§π‡•Ç‡§Ç, ‡§Ü‡§™‡§ï‡§æ sales assistant‡•§ ‡§Ü‡§ú ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•à‡§∏‡•á ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Ç?">‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§∞‡§æ‡§ú ‡§π‡•Ç‡§Ç, ‡§Ü‡§™‡§ï‡§æ sales assistant‡•§ ‡§Ü‡§ú ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•à‡§∏‡•á ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Ç?</textarea>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 8px;">
                            This will be the initial message from the agent. You can use variables here using {variable_name}
                        </p>
                    </div>
                </div>

                <div id="promptTab" class="tab-content">
                    <div class="form-group">
                        <label>Agent Prompt</label>
                        <textarea class="form-control" id="agentPrompt" style="min-height: 200px;" placeholder="‡§Ü‡§™ ‡§è‡§ï expert sales representative ‡§π‡•à‡§Ç ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§∞‡§æ‡§ú ‡§π‡•à‡•§ ‡§Ü‡§™ Hindi ‡§î‡§∞ English ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§≠‡§æ‡§∑‡§æ‡§ì‡§Ç ‡§Æ‡•á‡§Ç fluent ‡§π‡•à‡§Ç‡•§

‡§Ü‡§™‡§ï‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø goal ‡§π‡•à:
1. Customer ‡§ï‡•á ‡§∏‡§æ‡§• friendly relationship ‡§¨‡§®‡§æ‡§®‡§æ
2. Product/service ‡§ï‡•Ä benefits explain ‡§ï‡§∞‡§®‡§æ
3. Objections ‡§ï‡•ã handle ‡§ï‡§∞‡§®‡§æ
4. Sale close ‡§ï‡§∞‡§®‡§æ ‡§Ø‡§æ follow-up schedule ‡§ï‡§∞‡§®‡§æ

‡§Ü‡§™‡§ï‡•Ä personality:
- Confident ‡§≤‡•á‡§ï‡§ø‡§® humble
- Customer-focused approach
- Problem solver mindset
- Respectful ‡§î‡§∞ professional

You can define variables in the prompt using {variable_name}">‡§Ü‡§™ ‡§è‡§ï expert sales representative ‡§π‡•à‡§Ç ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§∞‡§æ‡§ú ‡§π‡•à‡•§ ‡§Ü‡§™ Hindi ‡§î‡§∞ English ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§≠‡§æ‡§∑‡§æ‡§ì‡§Ç ‡§Æ‡•á‡§Ç fluent ‡§π‡•à‡§Ç‡•§

‡§Ü‡§™‡§ï‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø goal ‡§π‡•à:
1. Customer ‡§ï‡•á ‡§∏‡§æ‡§• friendly relationship ‡§¨‡§®‡§æ‡§®‡§æ
2. Product/service ‡§ï‡•Ä benefits explain ‡§ï‡§∞‡§®‡§æ
3. Objections ‡§ï‡•ã handle ‡§ï‡§∞‡§®‡§æ
4. Sale close ‡§ï‡§∞‡§®‡§æ ‡§Ø‡§æ follow-up schedule ‡§ï‡§∞‡§®‡§æ

‡§Ü‡§™‡§ï‡•Ä personality:
- Confident ‡§≤‡•á‡§ï‡§ø‡§® humble
- Customer-focused approach
- Problem solver mindset
- Respectful ‡§î‡§∞ professional</textarea>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 8px;">
                            You can define variables in the prompt using {variable_name}
                        </p>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Setting up your agent...</p>
                </div>

                <div id="successMessage" class="success-message" style="display: none;">
                    <i class="fas fa-check-circle mr-2"></i>
                    Agent successfully configured!
                </div>

                <div id="errorMessage" class="error-message" style="display: none;">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="errorText">Something went wrong. Please try again.</span>
                </div>

                <div style="margin-top: 30px; display: flex; gap: 15px;">
                    <button class="btn btn-primary" onclick="saveAgent()" style="flex: 1;">
                        <i class="fas fa-save mr-2"></i>Save Agent Configuration
                    </button>
                    <button class="btn btn-secondary" onclick="testAgent()">
                        <i class="fas fa-phone mr-2"></i>Test Call
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const phoneNumber = urlParams.get('phone_number');
        const agentId = urlParams.get('agent_id');

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading state initially
            document.getElementById('loading').style.display = 'block';

            if (phoneNumber) {
                document.getElementById('phoneNumber').textContent = phoneNumber;
                // Try to find existing agent for this phone number
                loadAgentByPhoneNumber(phoneNumber);
            } else if (agentId) {
                document.getElementById('agentId').textContent = agentId;
                loadAgentData(agentId);
            } else {
                // No phone number or agent ID, just hide loading and set defaults
                setDefaultValues();
            }
        });

        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        async function loadAgentByPhoneNumber(phoneNumber) {
            try {
                // First, try to find existing agent for this phone number
                const response = await fetch(`/api/dev/voice-agents`);
                if (response.ok) {
                    const data = await response.json();
                    const agents = data.voice_agents || [];

                    // Find agent with matching phone number
                    const existingAgent = agents.find(agent => agent.phone_number === phoneNumber);

                    if (existingAgent) {
                        console.log('Found existing agent:', existingAgent);
                        document.getElementById('agentId').textContent = existingAgent.id;
                        populateFormWithAgentData(existingAgent);
                    } else {
                        console.log('No existing agent found for phone number:', phoneNumber);
                        // Set default values for new agent
                        setDefaultValues();
                    }
                }
            } catch (error) {
                console.error('Error loading agent by phone number:', error);
                setDefaultValues();
            }
        }

        async function loadAgentData(agentId) {
            try {
                const response = await fetch(`/api/dev/voice-agents/${agentId}`);
                if (response.ok) {
                    const data = await response.json();
                    const agent = data.agent || data;

                    console.log('Loaded agent data:', agent);
                    populateFormWithAgentData(agent);
                } else {
                    console.log('Agent not found, setting default values');
                    setDefaultValues();
                }
            } catch (error) {
                console.error('Error loading agent data:', error);
                setDefaultValues();
            }
        }

        function populateFormWithAgentData(agent) {
            // Hide loading state
            document.getElementById('loading').style.display = 'none';

            // Populate form with existing data
            document.getElementById('agentName').value = agent.name || agent.agent_name || '';
            document.getElementById('agentType').value = agent.type || agent.agent_type || 'sales';
            document.getElementById('voice').value = agent.voice || 'Aditi';
            document.getElementById('language').value = agent.language || agent.language_preference || 'hi';
            document.getElementById('welcomeMessage').value = agent.welcome_message || '';
            document.getElementById('agentPrompt').value = agent.prompt || agent.agent_prompt || '';

            console.log('Form populated with agent data');
        }

        function setDefaultValues() {
            // Hide loading state
            document.getElementById('loading').style.display = 'none';

            // Set default values for new agent (keeping only essential defaults)
            document.getElementById('agentType').value = 'sales';
            document.getElementById('voice').value = 'Aditi';
            document.getElementById('language').value = 'hi';

            console.log('Default values set');
        }

        async function saveAgent() {
            const loading = document.getElementById('loading');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');

            // Hide previous messages
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            loading.style.display = 'block';

            const agentData = {
                phone_number: phoneNumber,
                agent_name: document.getElementById('agentName').value,
                agent_type: document.getElementById('agentType').value,
                voice: document.getElementById('voice').value,
                language_preference: document.getElementById('language').value,
                welcome_message: document.getElementById('welcomeMessage').value,
                agent_prompt: document.getElementById('agentPrompt').value,
                conversation_style: 'professional',
                max_duration: 180
            };

            try {
                const currentAgentId = document.getElementById('agentId').textContent;
                let response, result;

                // Check if we're updating existing agent or creating new one
                if (currentAgentId && currentAgentId !== 'Not Assigned') {
                    console.log('Updating existing agent:', currentAgentId);

                    // Update existing agent - first update local database
                    response = await fetch(`/api/dev/voice-agents/${currentAgentId}/prompts`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(agentData)
                    });

                    result = await response.json();
                    console.log('Local database update result:', result);

                    if (response.ok) {
                        // Now update Bolna agent
                        const bolnaResponse = await fetch(`/api/dev/voice-agents/${currentAgentId}/bolna-update`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(agentData)
                        });

                        const bolnaResult = await bolnaResponse.json();
                        console.log('Bolna update result:', bolnaResult);

                        loading.style.display = 'none';

                        if (bolnaResponse.ok) {
                            successMessage.style.display = 'block';
                            alert('üéâ Agent updated successfully!\n\n‚úÖ Local database updated\n‚úÖ Bolna AI agent updated\n\nYour agent is ready for calls.');
                        } else {
                            successMessage.style.display = 'block';
                            alert('‚ö†Ô∏è Agent partially updated!\n\n‚úÖ Local database updated\n‚ùå Bolna AI update failed\n\nAgent may work with previous Bolna config.');
                        }
                    }
                } else {
                    console.log('Creating new agent');

                    // Create new agent
                    response = await fetch('/api/dev/voice-agents', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(agentData)
                    });

                    result = await response.json();
                    loading.style.display = 'none';

                    if (response.ok) {
                        successMessage.style.display = 'block';
                        document.getElementById('agentId').textContent = result.agent_id || result.id;
                        alert('üéâ Agent created successfully!\n\nYour agent is now configured and ready to handle calls.');
                    } else {
                        errorMessage.style.display = 'block';
                        document.getElementById('errorText').textContent = result.message || 'Failed to create agent';
                    }
                }

                // Redirect back to phone numbers page after 2 seconds
                if (response.ok) {
                    setTimeout(() => {
                        window.location.href = '/phone-numbers.html';
                    }, 2000);
                }

            } catch (error) {
                loading.style.display = 'none';
                errorMessage.style.display = 'block';
                document.getElementById('errorText').textContent = 'Network error. Please try again.';
                console.error('Error saving agent:', error);
            }
        }

        function testAgent() {
            if (!phoneNumber) {
                alert('Phone number is required for testing');
                return;
            }
            
            const testNumber = prompt('Enter phone number to test call:');
            if (testNumber) {
                alert(`Test call initiated to ${testNumber} from ${phoneNumber}`);
                // Here you would make an API call to initiate test call
            }
        }
    </script>
</body>
</html>
